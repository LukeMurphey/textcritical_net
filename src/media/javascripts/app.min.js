var TextCritical={};TextCritical.setFormatBreakLine=function(){$(".verse_container").addClass("block");$("#align_break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){$(".verse_container").removeClass("block");$("#align_break").removeClass("active")};TextCritical.toggleTOC=function(){$(".table_of_contents").toggle("fast","swing")};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.escapeIdentifier=function(a){return a.replace(".","\\.")};TextCritical.scrolltoAnchor=function(a){scrollTo=$("#"+a).offset();if(scrollTo==undefined){console.warn("The id ("+a+") to scroll to is undefined")}else{$("html,body").animate({scrollTop:scrollTo.top},"slow")}};TextCritical.scrollToVerse=function(d,b){if(b==null||b==undefined){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var e="verse_"+d;var a=TextCritical.escapeIdentifier(e);title=document.title;history.pushState({verse:d},title,b+"/"+d);console.info("Updating the URL to point to the selected verse");$(".verse_container").removeClass("highlighted");$(".verse.number").removeClass("label-info");$("#"+a).addClass("highlighted");$("#"+a+" .label").addClass("label-info");TextCritical.scrolltoAnchor(a);return false};TextCritical.loadStoreSettings=function(){var a={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",a);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(a){a=a.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");a=a.replace(/-/gi,"_");a=a.replace(/\s/gi,"-");return a};TextCritical.resolve_path=function(b,d){b=TextCritical.trim(b).toLowerCase();for(c=0;c<d.length;c++){d[c]=d[c].toLowerCase()}var e=window.location.pathname.split("/");var f=[];for(i=0;i<e.length;i++){if(e[i].length>0){f.push(e[i])}if(f.length>=2){break}}divisions_map={};for(c=0;c<d.length;c++){divisions_map[d[c]]=TextCritical.slugify(d[c]);b=b.replace(d[c],TextCritical.slugify(d[c]))}refs=b.split(/[ :._]+/);for(var a in divisions_map){for(c=0;c<refs.length;c++){refs[c]=refs[c].replace(divisions_map[a],a)}}return"/"+f.concat(refs).join("/")};TextCritical.go_to_chapter=function(a,b){document.location=TextCritical.resolve_path(a,b)};TextCritical.word_lookup=function(){work=$("h1[data-work-title-slug]").data("work-title-slug");TextCritical.open_morphology_dialog($(this).text(),work);return false};TextCritical.open_dialog=function(f,e,d){if(d==null||d==undefined){d=""}var b=$("#dialog-loading").html();$("#popup-dialog-content").html(e);var a='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';$("#popup-dialog-extra-options").html(d);$("#popup-dialog-label").text(f);$("#popup-dialog").modal()};TextCritical.open_morphology_dialog=function(e,d){console.info("Obtaining the morphology of "+e);e=TextCritical.trim(e);var b=$("#dialog-loading").html();$("#popup-dialog-content").html(_.template(b,{message:"Looking up morphology for "+_.escape(e)+"..."}));var a='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';$("#popup-dialog-extra-options").html(_.template(a,{word:e}));$("#popup-dialog-label").text("Morphology: "+_.escape(e));$("#popup-dialog").modal();$.ajax({url:"/api/word_parse/"+e}).done(function(g){var f=$("#morphology-info").html();$("#popup-dialog-content").html(_.template(f,{parses:g,word:_.escape(e),work:d}));$("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+e)}).error(function(f,h,g){$("#popup-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+e)})};TextCritical.trim=function(a){return String(a).replace(/^\s+|\s+$/g,"")};TextCritical.shorten=function(d,g,a,e){if(e==undefined||e==null){e="&hellip;"}if(a==undefined||a==null){a=true}var f=d.length>g,b=f?d.substr(0,g-1):d;b=a&&f?b.substr(0,b.lastIndexOf(" ")):b;return f?b+e:b};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word($(this).text())};TextCritical.unhighlight_all_words=function(){$(".word").removeClass("highlighted")};TextCritical.highlight_word=function(b){TextCritical.unhighlight_all_words();var a=new RegExp("^"+b+"$");console.info("Highlighting "+b);$(".word").filter(function(){return a.test($(this).text())}).addClass("highlighted")};TextCritical.contains_search_words=function(a){split_query=a.match(/([_0-9a-z]+[:][-_0-9a-z]+)|([\w_]+[:]["][-\w ]*["])|([^ :]+)/gi);for(c=0;c<split_query.length;c++){if(split_query[c].search(":")<0){return true}}return false};TextCritical.set_caret_at_end=function(d){var b=d.value.length;if(document.selection){d.focus();var a=document.selection.createRange();a.moveStart("character",-b);a.moveStart("character",b);a.moveEnd("character",0);a.select()}else{if(d.selectionStart||d.selectionStart=="0"){d.selectionStart=b;d.selectionEnd=b;d.focus()}}};TextCritical.set_search_url=function(b,a){if(a<=1||parseInt(a)<=1){url=document.location.pathname+"?&q="+b;a=1}else{url=document.location.pathname+"?q="+b+"&page="+a}history.pushState({query:b,page:a},document.title,url)};TextCritical.do_search=function(b,a){word=$("#search-term").val();if(b==undefined||b==null){if($("#page-number").val().length>0){b=parseInt($("#page-number").val());console.info("Getting page from #page-number:"+$("#page-number").val())}else{b=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+b)}related_forms=$("#related_forms:checked").length;if(a==undefined){a=true}if(related_forms==undefined){related_forms=0}else{if(!related_forms){related_forms=0}else{related_forms=1}}if(b<=0){console.warn("Page number is invalid (must be greater than zero)");b=1}$("#search-results-content").attr("data-page-number",b);$("#searching").show();$("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+b+" for "+word);$.ajax({url:"/api/search/?q="+word+"&page="+b+"&related_forms="+related_forms}).done(function(d){var e=$("#search-results").html();$("#search-results-content").html(_.template(e,{word:_.escape(word),search_results:d}));if(d.result_count>(d.page*d.page_len)){$(".next-page-link").click(TextCritical.do_search_next)}if(d.page>1){$(".previous-page-link").click(TextCritical.do_search_previous)}$("#search-results-content").unblock();console.info("Successfully searched for "+word);$("#searching").hide();$("#search-results-content").show();if(a){TextCritical.set_search_url(word,b)}}).error(function(d,f,e){$("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+word);$("#searching").hide();$("#search-results-content").show()});return false};TextCritical.show_search_help=function(a){if(a==undefined){a=true}if(a){$("#search-help").show();$("#search-results-content").hide()}else{$("#search-help").hide();$("#search-results-content").show()}};TextCritical.toggle_search_help=function(){if($("#search-help").is(":visible")){TextCritical.show_search_help(false)}else{TextCritical.show_search_help(true)}return false};TextCritical.do_fresh_search=function(){TextCritical.show_search_help(false);return TextCritical.do_search(1)};TextCritical.do_search_next=function(){return TextCritical.change_page(1)};TextCritical.change_page=function(a){page=parseInt($("#search-results-content").attr("data-page-number"));if(page==undefined){page=1}else{if(isNaN(page)){console.warn("Page number is invalid");page=1}else{page=page+a}}TextCritical.do_search(page)};TextCritical.search_this_work=function(){work=$("h1[data-work-title-slug]").data("work-title-slug");search_uri="/search?q=work:"+work;document.location=search_uri;return false};TextCritical.do_search_previous=function(){return TextCritical.change_page(-1)};TextCritical.search_page_popstate=function(a){if(a.state==null){return}$("#search-term").val(a.state.query);TextCritical.do_search(a.state.page,false)};TextCritical.convert_search_query_beta_code=function(){query=$("#search-term").val();$.ajax({url:"/api/convert_query_beta_code/?q="+query}).done(function(a){$("#search-term").val(a)})};TextCritical.works_search_typeahead_hints=[];TextCritical.get_works_search_typeahead_hints=function(){if(TextCritical.works_search_typeahead_hints.length>0){return TextCritical.works_search_typeahead_hints}else{console.info("Retrieving list of typeahead hints from the server");var a=$.ajax({url:"/api/works_typehead_hints",async:false,success:function(b){TextCritical.works_search_typeahead_hints=b},type:"GET"});return TextCritical.works_search_typeahead_hints}};TextCritical.show_alert=function(d,b,e){if(e==undefined||e==null){e="info"}var a=$("#alert-message").html();$("#messages").append(_.template(a,{title:_.escape(d),message:_.escape(b),level:e}))};TextCritical.update_work_url=function(a){if(location.pathname!==a){console.info("Updating the URL to reflect the canonical URL");title=document.title;history.replaceState({},title,a);TextCritical.show_alert("Stale URL","The URL you were using was old so redirected to the new one. You may want to update your shortcuts.","info")}};TextCritical.get_note_content=function(d,b,a){if(b==undefined||b==null){b=false}if(b>0){content=TextCritical.shorten($("#content_for_"+d).text(),b,true,a)}else{content=$("#content_for_"+d).html()}return content};TextCritical.get_note_title=function(a){note_number=$("#"+a).attr("data-note-number");if(note_number!=null){return"Note "+note_number}else{return"Note"}};TextCritical.open_note_dialog=function(a){title=TextCritical.get_note_title($(this).attr("id"));content=TextCritical.get_note_content($(this).attr("id"));TextCritical.open_dialog(title,content);return false};