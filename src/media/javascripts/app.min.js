var TextCritical={};function findGetParameter(b){var a=null,c=[];location.search.substr(1).split("&").forEach(function(d){c=d.split("=");if(c[0]===b){a=decodeURIComponent(c[1])}});return a}console.log();define(["jquery","underscore","highcharts","libs/text!/media/templates/alert_message.html","libs/text!/media/templates/morphology_dialog.html","libs/text!/media/templates/work_info_dialog.html","libs/text!/media/templates/wiki_info_dialog.html","libs/text!/media/templates/loading_dialog.html","libs/text!/media/templates/search_results.html","libs/text!/media/templates/copy_dialog.html","store","libs/optional!facebook"],function(d,j,g,b,e,c,a,h,f,i){TextCritical.setFormatBreakLine=function(){d(".verse-container").addClass("block");d(".align-break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){d(".verse-container").removeClass("block");d(".align-break").removeClass("active")};TextCritical.toggleTOC=function(){if(d(".table-of-contents").is(":visible")){d("#show-table-of-contents-phone").text("Show table of contents")}else{d("#show-table-of-contents-phone").text("Hide table of contents")}d(".table-of-contents").toggle("fast",function(){d(".division-filter").val("");d(".division-filter").change()})};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.escapeIdentifier=function(k){return k.replace(".","\\.")};TextCritical.scrolltoAnchor=function(k){scrollTo=d("#"+k).offset();if(typeof scrollTo=="undefined"){console.warn("The id ("+k+") to scroll to is undefined")}else{d("html,body").animate({scrollTop:scrollTo.top},"slow")}};TextCritical.scrollToVerse=function(m,l){if(typeof l=="undefined"||l==null){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var n="verse-"+m;var k=TextCritical.escapeIdentifier(n);title=document.title;history.pushState({verse:m},title,l+"/"+m+document.location.search);console.info("Updating the URL to point to the selected verse");d(".verse-container").removeClass("highlighted");d(".verse.number").removeClass("label-info");d("#"+k).addClass("highlighted");d("#"+k+" .label").addClass("label-info");TextCritical.scrolltoAnchor(k);return false};TextCritical.loadStoreSettings=function(){var k={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",k);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(k){k=k.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");k=k.replace(/-/gi,"_");k=k.replace(/\s/gi,"-");return k};TextCritical.go_to_chapter=function(k,l){document.location=TextCritical.resolve_path(l,k)};TextCritical.word_lookup=function(){var k=d(".work-data[data-work-title-slug]").data("work-title-slug");var l=d("#chapter-base-url").data();if(l&&l.chapterDescription){TextCritical.open_morphology_dialog(d(this).text(),k,l.chapterDescription)}else{TextCritical.open_morphology_dialog(d(this).text(),k)}return false};TextCritical.open_dialog=function(n,m,l){if(typeof l=="undefined"||l==null){l=""}d("#popup-dialog-content").html(m);var k='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';d("#popup-dialog-extra-options").html(l);d("#popup-dialog-label").text(n);d("#popup-dialog").modal()};TextCritical.open_morphology_dialog=function(m,l,n){if(typeof n==="undefined"){var n=null}console.info("Obtaining the morphology of "+m);m=TextCritical.trim(m);d("#popup-dialog-content").html(j.template(h,{message:"Looking up morphology for "+j.escape(m)+"..."}));var k='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';d("#popup-dialog-extra-options").html(j.template(k,{word:m}));d("#popup-dialog-label").text("Morphology: "+j.escape(m));d("#popup-dialog").modal();d.ajax({url:"/api/word_parse/"+m}).done(function(o){d("#popup-dialog-content").html(j.template(e,{parses:o,word:j.escape(m),work:l,division:j.escape(n)}));d("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+m)}).error(function(o,q,p){d("#popup-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+m)})};TextCritical.open_copy_dialog=function(k){k=TextCritical.trim(k);d("#popup-dialog-content").html(j.template(i,{text_to_copy:k}));d("#popup-dialog-extra-options").html("");d("#popup-dialog-label").text("Copy to clipboard");d("#popup-dialog").modal();setTimeout(function(){d(".clipboard-copy-text").focus();d(".clipboard-copy-text")[0].setSelectionRange(0,5000)},800);d(".clipboard-copy-text").on("click",function(){d(".clipboard-copy-text").focus();d(".clipboard-copy-text")[0].setSelectionRange(0,5000)})};TextCritical.get_work_info=function(k){var l="/api/work_info/"+k;var m=jQuery.Deferred();d.ajax({url:l}).done(function(n){n.work=k;n.success=true;console.info("Successfully performed a request for information on the work "+k);m.resolve(n)}).error(function(n,p,o){data={work:k,success:false};if(n.status===404){console.warn("No information could be obtained for the work "+k)}else{console.error("The request on the work failed for "+k)}m.reject(n,data)});return m};TextCritical.open_work_info_dialog=function(k,l){console.info("Obtaining information about "+k);search=TextCritical.trim(search);d("#popup-dialog-content").html(j.template(h,{message:"Looking up info for work "+j.escape(l)+"..."}));d("#popup-dialog-extra-options").html("");d("#popup-dialog-label").text(j.escape(l));d("#popup-dialog").modal();this.get_work_info(k).done(function(n){var m='<a target="_blank" class="external" href="<%= url %>">View on wikipedia</a>';d("#popup-dialog-extra-options").html(j.template(m,{url:n.wiki_info.url}));d("#popup-dialog-content").html(j.template(c,n))}).fail(function(m,n){if(m.status===404){d("#popup-dialog-content").html(j.template(c,n))}else{d("#popup-dialog-content").html("<h4>Request failed</h4> The request for information on this work could not be completed")}})};TextCritical.open_topic_dialog_for_element=function(){TextCritical.open_topic_dialog(this.dataset.querytitle,this.dataset.query,this.dataset.query2,this.dataset.query3)};TextCritical.open_topic_dialog=function(k,l,n,m){console.info("Obtaining information about "+k);l=TextCritical.trim(l);d("#popup-dialog-content").html(j.template(h,{message:"Looking up info for "+j.escape(k)+"..."}));d("#popup-dialog-extra-options").html("");d("#popup-dialog-label").text(j.escape(k));d("#popup-dialog").modal();this.get_wiki_info(k,l,n,m).done(function(p){var o='<a target="_blank" class="external" href="<%= url %>">View on wikipedia</a>';d("#popup-dialog-extra-options").html(j.template(o,{url:p.url}));d("#popup-dialog-content").html(j.template(a,p))}).fail(function(o,p){if(o.status===404){d("#popup-dialog-content").html(j.template(a,p))}else{d("#popup-dialog-content").html("<h4>Request failed</h4> The request for information could not be completed")}})};TextCritical.get_wiki_info=function(l,m,o,n){if(typeof m==="undefined"){var m=l}if(typeof o==="undefined"){var o=null}if(typeof n==="undefined"){var n=null}var k="/api/wikipedia_info/"+m;if(o!==null&&n!==null){k="/api/wikipedia_info/"+m+"/"+o+"/"+n}else{if(o!==null){k="/api/wikipedia_info/"+m+"/"+o}else{if(n!==null){k="/api/wikipedia_info/"+m+"/"+n}}}var p=jQuery.Deferred();d.ajax({url:k}).done(function(q){q.topic=l;q.success=true;console.info("Successfully performed a request for information on "+l);p.resolve(q)}).error(function(q,s,r){data={topic:l,success:false};if(q.status===404){console.warn("No information could be obtained for "+l)}else{console.error("The request on the topic failed for "+l)}p.reject(q,data)});return p};TextCritical.trim=function(k){return String(k).replace(/^\s+|\s+$/g,"")};TextCritical.shorten=function(m,q,k,o){if(typeof o=="undefined"||o==null){var o="&hellip;"}if(typeof k=="undefined"||k==null){var k=true}var p=m.length>q,l=p?m.substr(0,q-1):m;l=k&&p?l.substr(0,l.lastIndexOf(" ")):l;return p?l+o:l};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word(d(this).text())};TextCritical.unhighlight_all_words=function(k){if(typeof k=="undefined"){var k="highlighted"}d(".word").removeClass(k)};TextCritical.normalize=function(k){if(k.hasOwnProperty("normalize")){return k.normalize()}else{return k}};TextCritical.highlight_word=function(o,n,k){if(typeof n=="undefined"){var n="highlighted"}if(typeof k=="undefined"){var k=true}if(k){TextCritical.unhighlight_all_words(n)}var m=TextCritical.escape_regex(TextCritical.normalize(o));var l=new RegExp("^"+m+"$","i");console.info("Highlighting "+o);d(".word").filter(function(){return l.test(TextCritical.normalize(d(this).text()))}).addClass(n)};TextCritical.make_bar_chart=function(o,q,n,k){if(typeof k==="undefined"){k="No data matched"}var l=[];var p=[];if(n){for(var m in n){if(n.hasOwnProperty(m)){l.push(m);p.push(n[m])}}}if(p.length===0){o.html('<div class="alert alert-info alert-block">'+k+"</div>");return false}o.highcharts({colors:["#006dcc"],chart:{type:"bar",backgroundColor:"#2f2f2f",width:d(".tab-pane.active").width()},title:{text:q,style:{color:"#DDD"}},legend:{enabled:false},xAxis:{categories:l,title:{text:null},labels:{style:{color:"#DDD"}},lineColor:"#DDD",tickColor:"#DDD"},yAxis:{min:0,title:{text:"Count",align:"high"},labels:{overflow:"justify",style:{color:"#DDD"}}},plotOptions:{bar:{dataLabels:{enabled:false}}},credits:{enabled:false},series:[{name:"Count",data:p}]})},TextCritical.do_search=function(l,k){var m=d("#search-term").val();if(typeof l=="undefined"||l==null){if(d("#page-number").val().length>0){l=parseInt(d("#page-number").val());console.info("Getting page from #page-number:"+d("#page-number").val())}else{l=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+l)}related_forms=d("#related_forms:checked").length;ignore_diacritics=d("#ignore_diacritics:checked").length;if(typeof k=="undefined"){k=true}if(typeof related_forms=="undefined"){related_forms=0}else{if(!related_forms){related_forms=0}else{related_forms=1}}if(typeof ignore_diacritics=="undefined"){ignore_diacritics=0}else{if(!ignore_diacritics){ignore_diacritics=0}else{ignore_diacritics=1}}if(l<=0){console.warn("Page number is invalid (must be greater than zero)");l=1}d("#search-results-content").attr("data-page-number",l);d("#searching").show();d("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+l+" for "+m);d.ajax({url:"/api/search/"+encodeURIComponent(m)+"?page="+l+"&related_forms="+related_forms+"&ignore_diacritics="+ignore_diacritics}).done(function(n){d("#search-results-content").html(j.template(f,{word:j.escape(m),search_results:n}));if(n.result_count>(n.page*n.page_len)){d(".next-page-link").click(TextCritical.do_search_next)}if(n.page>1){d(".previous-page-link").click(TextCritical.do_search_previous)}d("#search-results-content").unblock();console.info("Successfully searched for "+m);TextCritical.make_bar_chart(d("#chart-word-frequency"),"Frequency of matched words",n.matched_terms,"No data available on matched terms");TextCritical.make_bar_chart(d("#chart-work-frequency"),"Number of matched verses by work",n.matched_works,"No data available on matched works");TextCritical.make_bar_chart(d("#chart-section-frequency"),"Number of matched verses by section",n.matched_sections,"No data available on matched sections");d("#searching").hide();d("#search-results-content").show();if(k){TextCritical.set_search_url(m,l,related_forms,ignore_diacritics)}}).error(function(n,p,o){d("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+m);d("#searching").hide();d("#search-results-content").show()});return false};TextCritical.change_page=function(l){var k=parseInt(d("#search-results-content").attr("data-page-number"));if(typeof k=="undefined"){k=1}else{if(isNaN(k)){console.warn("Page number is invalid");k=1}else{k=k+l}}TextCritical.do_search(k)};TextCritical.search_this_work=function(){var k=d(".work-data[data-work-title-slug]").data("work-title-slug");var m="/search?q=work:"+k;var l=d("#chapter-base-url").data();if(l){m+=' section:"'+l.chapterDescription+'"'}document.location=m;return false};TextCritical.convert_search_query_beta_code=function(){var k=d("#search-term").val();d.ajax({url:"/api/convert_query_beta_code/?q="+k}).done(function(l){d("#search-term").val(l)})};TextCritical.add_word_morphology_links=function(k,n){if(typeof n==="undefined"){var n=k.text()}var m=n.split(" ");k.text("");for(var l=0;l<m.length;l++){k.append('<span class="word">'+m[l]+" </span>")}};TextCritical.get_related_forms=function(){query=encodeURIComponent(d("#text").val());d.ajax({url:"/api/word_forms/"+query}).done(function(k){d("#output").text(k.forms.join(", ").toLowerCase())})};TextCritical.flatten_typeahead_hints=function(l){hints_flattened=[];for(var k=0;k<l.length;k++){if(j.indexOf(hints_flattened,l[k].desc)<0){hints_flattened.push(l[k].desc)}}return hints_flattened};TextCritical.works_search_typeahead_hints=[];TextCritical.works_search_typeahead_hints_flattened=[];TextCritical.get_works_search_typeahead_hints=function(k){var m=jQuery.Deferred();if(typeof k=="undefined"){var k=true}if(TextCritical.works_search_typeahead_hints_flattened.length>0){console.info("Type-ahead hints already available via the cache");if(k){m.resolve(TextCritical.works_search_typeahead_hints_flattened)}else{m.resolve(TextCritical.works_search_typeahead_hints)}}else{console.info("Retrieving list of typeahead hints from the server");var m=jQuery.Deferred();var l=d.ajax({url:"/api/works_typeahead_hints",success:function(n){TextCritical.works_search_typeahead_hints=n;TextCritical.works_search_typeahead_hints_flattened=TextCritical.flatten_typeahead_hints(TextCritical.works_search_typeahead_hints);if(k){m.resolve(TextCritical.works_search_typeahead_hints_flattened)}else{m.resolve(TextCritical.works_search_typeahead_hints)}},type:"GET"})}return m};TextCritical.jump_to_searched_text=function(k){list=TextCritical.works_search_typeahead_hints;found=0;url=null;for(var l=0;l<list.length;l++){if(list[l].desc==k){found=found+1;url=list[l].url}}if(found>1||found==0||url==null||url==""){return false}else{location=url;return true}};TextCritical.show_alert=function(n,m,o,l){if(typeof o=="undefined"||o==null){o="info"}if(typeof l=="undefined"){l=null}d("#messages").append(j.template(b,{title:j.escape(n),message:j.escape(m),level:o}));var k=d("#messages  > .alert:last-child");if(l!==null&&l>0){setTimeout(function(){k.animate({height:"0px","margin-top":"0px","margin-bottom":"0px","padding-top":"0px","padding-bottom":"0px"},250,function(){k.remove()})},l)}};TextCritical.show_small_alert=function(k){d("#small-message  > .message-text").html(k);d("#small-message").show();setTimeout(function(){d("#small-message").slideUp(100)},2500)};TextCritical.update_work_url=function(k){if(location.pathname!==k){console.info("Updating the URL to reflect the canonical URL");title=document.title;history.replaceState({},title,k);TextCritical.show_alert("Stale URL","The URL you were using was old so redirected to the new one. You may want to update your shortcuts.","info")}};TextCritical.make_shareable_url=function(){if(location.pathname.indexOf("/work/")==0){return location.protocol+"//"+location.host+location.pathname}else{return TextCritical.trimTrailingPound(location.href)}};TextCritical.get_note_content=function(m,l,k){if(typeof l==undefined||l==null){var l=false}if(l>0){content=TextCritical.shorten(d("#content_for_"+m).text(),l,true,k)}else{content=d("#content_for_"+m).html()}return content};TextCritical.get_note_title=function(k){note_number=d("#"+k).attr("data-note-number");if(note_number!=null){return"Note "+note_number}else{return"Note"}};TextCritical.open_note_dialog=function(k){title=TextCritical.get_note_title(d(this).attr("id"));content=TextCritical.get_note_content(d(this).attr("id"));TextCritical.open_dialog(title,content);return false};TextCritical.escape_regex=function(k){return k.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")};TextCritical.highlight_searched_terms=function(){var k=TextCritical.get_parameter_by_name(document.location.search,"highlight",true);if(k!==undefined){for(var l=0;l<k.length;l++){TextCritical.highlight_word(decodeURIComponent(k[l]),"searched",false)}}};TextCritical.get_parameter_by_name=function(m,l,p){if(typeof p=="undefined"){var p=false}l=l.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var o=new RegExp("[\\?&]"+l+"(=([^&#]*))?","g");var n;var k=[];while(n=o.exec(m)){if(n[2]!==undefined){k.push(n[2].replace(/\+/g," "))}else{k.push("")}if(!p){return k[0]}}if(k.length==0){return undefined}else{return k}};TextCritical.add_async_parameter=function(k){if(TextCritical.get_parameter_by_name(k,"async")!==undefined){}else{if(k.indexOf("?")>0){k=k+"&async"}else{k=k+"?async"}}return k};TextCritical.load_ajah=function(k){k=TextCritical.add_async_parameter(k);d.ajax({url:k,success:function(l){console.info("Loading page content with asynchronous request");d("#main-content").html(l).fadeIn("slow");d("#async-loading-message").hide();console.info("Sucessfully loaded page content with asynchronous request")},error:function(l,n,m){console.error("Failed to load the page content with asynchronous request");d("#main-content").html("<h3>Yikes! That didn't work</h3>I'm sorry, but the content couldn't be loaded").fadeIn("slow");d("#async-loading-message").hide()}})};TextCritical.pre_load_next_link=function(){next_href=d("link[rel=next]").attr("href");if(next_href!==undefined){next_href=TextCritical.add_async_parameter(next_href);console.info("Beginning request to cache content of the next chapter ("+next_href+")");d.ajax({url:next_href}).done(function(k){console.info("Successfully cached the contents of the next chapter at "+next_href)}).error(function(k,m,l){console.error("Request for next chapter's content failed (url attempted was "+next_href+")")})}};TextCritical.convert_search_query_beta_code=function(k){converted_beta_code=null;d.ajax({async:false,url:"/api/beta_code_to_unicode/?text="+k}).done(function(l){converted_beta_code=l.unicode});return converted_beta_code};TextCritical.freeze_height=function(k){d(k).css("height",d(k).height())};TextCritical.unfreeze_height=function(k){d(k).css("height","auto")};TextCritical.data_attribute_contains=function(k,m){for(var l=0;l<k.length;l++){attribute=k[l];if(attribute.name.indexOf("data-")==0){if(attribute.value.toLowerCase().indexOf(m)>=0){return true}}}return false};TextCritical.list_filter=function(k,m,l){if(typeof l=="undefined"){var l=false}d(k).change(function(){var n=d(this).val().toLowerCase();if(n){if(l){TextCritical.freeze_height(m)}d(m).find("a").each(function(o){if(d(this).text().toLowerCase().indexOf(n)>=0){d(this).parent().show()}else{if(TextCritical.data_attribute_contains(this.attributes,n)){d(this).parent().show()}else{d(this).parent().hide()}}})}else{d(m).find("li").show();if(l){TextCritical.unfreeze_height(m)}}return false}).keyup(function(){d(this).change()})};TextCritical.resolve_path=function(n,k){var l=null;var m=d.ajax({url:"/api/resolve_reference/?work="+n+"&ref="+k,async:false,success:function(o){l=o.url},type:"GET"});return l};TextCritical.facebookInit=function(){if(typeof FB!=="undefined"){FB.init({appId:"226685657481279",xfbml:true})}};TextCritical.getTextToShare=function(l,k){if(typeof l==="undefined"||l==null){var l=""}if(TextCritical.trim(l).length==0||k===true){if(window.getSelection().toString().length>0){l=window.getSelection().toString()}else{if(d(".verse-container.highlighted .verse:not(.label)").length>0){l=d(".verse-container.highlighted .verse:not(.label)").text()}else{if(d(".verse-container").length>0){l=d(".verse-container").clone().children().remove().end().text()}}}}l=TextCritical.trim(l);l=l.replace(/[ ]*(\n|\t)[ ]*/g," ");l=l.replace(/ [ ]+/gi," ");return l};TextCritical.trimTrailingPound=function(k){if(k.slice(-1)=="#"){return k.slice(0,k.length-1)}else{return k}};TextCritical.postToFacebook=function(k,o,m,n,l){if(typeof n==="undefined"||n==null){var n=TextCritical.make_shareable_url()}else{n=TextCritical.trimTrailingPound(n)}if(typeof l==="undefined"||l==null){var l=document.title}o=TextCritical.getTextToShare(o,m);FB.ui({method:"feed",link:n,name:l,caption:k,description:TextCritical.shorten(o,400,true,"...")},function(p){})};TextCritical.makeTweetURL=function(l,m,k){if(typeof l==="undefined"||l==null){var l=location.href}m=TextCritical.getTextToShare(m,k);twitterLink="https://twitter.com/share";data={url:TextCritical.trimTrailingPound(l),text:TextCritical.shorten(m,140-l.length,true,"...")};return twitterLink+"?"+d.param(data)};TextCritical.postToTwitter=function(m,k,l){twitterLink=TextCritical.makeTweetURL(l,m,k);window.open(twitterLink,"_blank")};TextCritical.serialize=function(l){var m=[];for(var k in l){m.push(encodeURIComponent(k)+"="+encodeURIComponent(l[k]))}return m.join("&")};TextCritical.sendAnEmail=function(m,k,l,n){if(typeof n==="undefined"||n==null){n=location.href}if(m===undefined||n==null){m=document.title}k=TextCritical.getTextToShare(k,l);data={subject:m,body:TextCritical.shorten(k,1000,true,"...")+"\n\n[Source: "+TextCritical.trimTrailingPound(n)+"]",};document.location.href="mailto:?"+TextCritical.serialize(data)};TextCritical.pollForShareButtons=function(){if(d("iframe",".sharing-buttons").length<2){setTimeout(TextCritical.pollForShareButtons,200)}else{setTimeout(function(){d(".sharing-buttons").fadeIn(400,function(){d(".sharing-buttons").removeClass("hide").css("display","")})},1500)}};d("body").delegate(".wiki-info","click",function(){TextCritical.open_topic_dialog(this.dataset.querytitle,this.dataset.query,this.dataset.query2,this.dataset.query3);return false});d("body").delegate(".open-work-info","click",function(){TextCritical.open_work_info_dialog(this.dataset.workTitleSlug,this.dataset.workTitle);return false})});