var TextCritical={};define(["jquery","underscore","libs/text!/media/templates/alert_message.html","libs/text!/media/templates/morphology_dialog.html","libs/text!/media/templates/loading_dialog.html","libs/text!/media/templates/search_results.html"],function(f,d,e,b,a,g){TextCritical.setFormatBreakLine=function(){f(".verse-container").addClass("block");f(".align-break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){f(".verse-container").removeClass("block");f(".align-break").removeClass("active")};TextCritical.toggleTOC=function(){if(f(".table-of-contents").is(":visible")){f("#show-table-of-contents-phone").text("Show table of contents")}else{f("#show-table-of-contents-phone").text("Hide table of contents")}f(".table-of-contents").toggle("fast",function(){f(".division-filter").val("");f(".division-filter").change()})};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.escapeIdentifier=function(h){return h.replace(".","\\.")};TextCritical.scrolltoAnchor=function(h){scrollTo=f("#"+h).offset();if(scrollTo==undefined){console.warn("The id ("+h+") to scroll to is undefined")}else{f("html,body").animate({scrollTop:scrollTo.top},"slow")}};TextCritical.scrollToVerse=function(j,i){if(i==null||i==undefined){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var k="verse-"+j;var h=TextCritical.escapeIdentifier(k);title=document.title;history.pushState({verse:j},title,i+"/"+j);console.info("Updating the URL to point to the selected verse");f(".verse-container").removeClass("highlighted");f(".verse.number").removeClass("label-info");f("#"+h).addClass("highlighted");f("#"+h+" .label").addClass("label-info");TextCritical.scrolltoAnchor(h);return false};TextCritical.loadStoreSettings=function(){var h={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",h);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(h){h=h.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");h=h.replace(/-/gi,"_");h=h.replace(/\s/gi,"-");return h};TextCritical.go_to_chapter=function(h,i){document.location=TextCritical.resolve_path(i,h)};TextCritical.word_lookup=function(){work=f("h1[data-work-title-slug]").data("work-title-slug");TextCritical.open_morphology_dialog(f(this).text(),work);return false};TextCritical.open_dialog=function(k,j,i){if(i==null||i==undefined){i=""}f("#popup-dialog-content").html(j);var h='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';f("#popup-dialog-extra-options").html(i);f("#popup-dialog-label").text(k);f("#popup-dialog").modal()};TextCritical.open_morphology_dialog=function(j,i){console.info("Obtaining the morphology of "+j);j=TextCritical.trim(j);f("#popup-dialog-content").html(d.template(a,{message:"Looking up morphology for "+d.escape(j)+"..."}));var h='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';f("#popup-dialog-extra-options").html(d.template(h,{word:j}));f("#popup-dialog-label").text("Morphology: "+d.escape(j));f("#popup-dialog").modal();f.ajax({url:"/api/word_parse/"+j}).done(function(k){f("#popup-dialog-content").html(d.template(b,{parses:k,word:d.escape(j),work:i}));f("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+j)}).error(function(k,m,l){f("#popup-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+j)})};TextCritical.trim=function(h){return String(h).replace(/^\s+|\s+$/g,"")};TextCritical.shorten=function(j,m,h,k){if(k==undefined||k==null){k="&hellip;"}if(h==undefined||h==null){h=true}var l=j.length>m,i=l?j.substr(0,m-1):j;i=h&&l?i.substr(0,i.lastIndexOf(" ")):i;return l?i+k:i};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word(f(this).text())};TextCritical.unhighlight_all_words=function(){f(".word").removeClass("highlighted")};TextCritical.highlight_word=function(i){TextCritical.unhighlight_all_words();escaped_word=TextCritical.escape_regex(i);var h=new RegExp("^"+escaped_word+"$");console.info("Highlighting "+i);f(".word").filter(function(){return h.test(f(this).text())}).addClass("highlighted")};TextCritical.contains_search_words=function(h){split_query=h.match(/([_0-9a-z]+[:][-_0-9a-z]+)|([\w_]+[:]["][-\w ]*["])|([^ :]+)/gi);for(c=0;c<split_query.length;c++){if(split_query[c].search(":")<0){return true}}return false};TextCritical.set_caret_at_end=function(j){var i=j.value.length;if(document.selection){j.focus();var h=document.selection.createRange();h.moveStart("character",-i);h.moveStart("character",i);h.moveEnd("character",0);h.select()}else{if(j.selectionStart||j.selectionStart=="0"){j.selectionStart=i;j.selectionEnd=i;j.focus()}}};TextCritical.set_search_url=function(i,h){if(h<=1||parseInt(h)<=1){url=document.location.pathname+"?&q="+i;h=1}else{url=document.location.pathname+"?q="+i+"&page="+h}history.pushState({query:i,page:h},document.title,url)};TextCritical.do_search=function(i,h){word=f("#search-term").val();if(i==undefined||i==null){if(f("#page-number").val().length>0){i=parseInt(f("#page-number").val());console.info("Getting page from #page-number:"+f("#page-number").val())}else{i=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+i)}related_forms=f("#related_forms:checked").length;if(h==undefined){h=true}if(related_forms==undefined){related_forms=0}else{if(!related_forms){related_forms=0}else{related_forms=1}}if(i<=0){console.warn("Page number is invalid (must be greater than zero)");i=1}f("#search-results-content").attr("data-page-number",i);f("#searching").show();f("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+i+" for "+word);f.ajax({url:"/api/search/?q="+encodeURIComponent(word)+"&page="+i+"&related_forms="+related_forms}).done(function(j){f("#search-results-content").html(d.template(g,{word:d.escape(word),search_results:j}));if(j.result_count>(j.page*j.page_len)){f(".next-page-link").click(TextCritical.do_search_next)}if(j.page>1){f(".previous-page-link").click(TextCritical.do_search_previous)}f("#search-results-content").unblock();console.info("Successfully searched for "+word);f("#searching").hide();f("#search-results-content").show();if(h){TextCritical.set_search_url(word,i)}}).error(function(j,l,k){f("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+word);f("#searching").hide();f("#search-results-content").show()});return false};TextCritical.show_search_help=function(h){if(h==undefined){h=true}if(h){f("#search-help").show();f("#search-results-content").hide()}else{f("#search-help").hide();f("#search-results-content").show()}};TextCritical.toggle_search_help=function(){if(f("#search-help").is(":visible")){TextCritical.show_search_help(false)}else{TextCritical.show_search_help(true)}return false};TextCritical.do_fresh_search=function(){TextCritical.show_search_help(false);return TextCritical.do_search(1)};TextCritical.do_search_next=function(){return TextCritical.change_page(1)};TextCritical.change_page=function(h){page=parseInt(f("#search-results-content").attr("data-page-number"));if(page==undefined){page=1}else{if(isNaN(page)){console.warn("Page number is invalid");page=1}else{page=page+h}}TextCritical.do_search(page)};TextCritical.search_this_work=function(){work=f("h1[data-work-title-slug]").data("work-title-slug");search_uri="/search?q=work:"+work;document.location=search_uri;return false};TextCritical.do_search_previous=function(){return TextCritical.change_page(-1)};TextCritical.search_page_popstate=function(h){if(h.state==null){return}f("#search-term").val(h.state.query);TextCritical.do_search(h.state.page,false)};TextCritical.convert_search_query_beta_code=function(){query=f("#search-term").val();f.ajax({url:"/api/convert_query_beta_code/?q="+query}).done(function(h){f("#search-term").val(h)})};TextCritical.works_search_typeahead_hints=[];TextCritical.works_search_typeahead_hints_flattened=[];TextCritical.get_works_search_typeahead_hints=function(j){if(j==undefined){j=true}if(TextCritical.works_search_typeahead_hints_flattened.length>0){if(j){return TextCritical.works_search_typeahead_hints_flattened}else{return TextCritical.works_search_typeahead_hints}}else{console.info("Retrieving list of typeahead hints from the server");var k=f.ajax({url:"/api/works_typehead_hints",async:false,success:function(i){TextCritical.works_search_typeahead_hints=i},type:"GET"});hints_flattened=[];for(var h=0;h<TextCritical.works_search_typeahead_hints.length;h++){if(d.indexOf(hints_flattened,TextCritical.works_search_typeahead_hints[h].desc)<0){hints_flattened.push(TextCritical.works_search_typeahead_hints[h].desc)}}TextCritical.works_search_typeahead_hints_flattened=hints_flattened;return TextCritical.works_search_typeahead_hints_flattened}};TextCritical.jump_to_searched_text=function(h){list=TextCritical.get_works_search_typeahead_hints(false);found=0;url=null;for(var i=0;i<list.length;i++){if(list[i].desc==h){found=found+1;url=list[i].url}}if(found>1||found==0||url==null){return false}else{location=url;return true}};TextCritical.show_alert=function(i,h,j){if(j==undefined||j==null){j="info"}f("#messages").append(d.template(e,{title:d.escape(i),message:d.escape(h),level:j}))};TextCritical.update_work_url=function(h){if(location.pathname!==h){console.info("Updating the URL to reflect the canonical URL");title=document.title;history.replaceState({},title,h);TextCritical.show_alert("Stale URL","The URL you were using was old so redirected to the new one. You may want to update your shortcuts.","info")}};TextCritical.get_note_content=function(j,i,h){if(i==undefined||i==null){i=false}if(i>0){content=TextCritical.shorten(f("#content_for_"+j).text(),i,true,h)}else{content=f("#content_for_"+j).html()}return content};TextCritical.get_note_title=function(h){note_number=f("#"+h).attr("data-note-number");if(note_number!=null){return"Note "+note_number}else{return"Note"}};TextCritical.open_note_dialog=function(h){title=TextCritical.get_note_title(f(this).attr("id"));content=TextCritical.get_note_content(f(this).attr("id"));TextCritical.open_dialog(title,content);return false};TextCritical.escape_regex=function(h){return h.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")};TextCritical.get_parameter_by_name=function(i,h){h=h.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var k=new RegExp("[\\?&]"+h+"(=([^&#]*))?"),j=k.exec(i);if(j==null){return undefined}else{if(j[2]!==undefined){return j[2].replace(/\+/g," ")}else{return""}}};TextCritical.add_async_parameter=function(h){if(TextCritical.get_parameter_by_name(h,"async")!==undefined){}else{if(h.indexOf("?")>0){h=h+"&async"}else{h=h+"?async"}}return h};TextCritical.load_ajah=function(h){h=TextCritical.add_async_parameter(h);f.ajax({url:h,success:function(i){console.info("Loading page content with asynchronous request");f("#main-content").html(i).fadeIn("slow");f("#async-loading-message").hide();console.info("Sucessfully loaded page content with asynchronous request")},error:function(i,k,j){console.error("Failed to load the page content with asynchronous request");f("#main-content").html("<h3>Yikes! That didn't work</h3>I'm sorry, but the content couldn't be loaded").fadeIn("slow");f("#async-loading-message").hide()}})};TextCritical.setup_link_handlers_for_ios_web_apps=function(){if(("standalone" in window.navigator)&&window.navigator.standalone){f(document).on("click","a",function(i){var h=f(this).attr("href");if(i.target.target!="_blank"&&(h.indexOf(location.hostname)>-1||h.indexOf("http")!=0)){i.preventDefault();var j=h;if(j!=undefined&&j.substr(0,1)!="#"&&f(this).attr("data-method")==undefined){window.location=j}}})}};TextCritical.pre_load_next_link=function(){next_href=f("link[rel=next]").attr("href");if(next_href!==undefined){next_href=TextCritical.add_async_parameter(next_href);console.info("Beginning request to cache content of the next chapter ("+next_href+")");f.ajax({url:next_href}).done(function(h){console.info("Successfully cached the contents of the next chapter at "+next_href)}).error(function(h,j,i){console.error("Request for next chapter's content failed (url attempted was "+next_href+")")})}};TextCritical.convert_search_query_beta_code=function(h){converted_beta_code=null;f.ajax({async:false,url:"/api/beta_code_to_unicode/?text="+h}).done(function(i){converted_beta_code=i.unicode});return converted_beta_code};TextCritical.freeze_height=function(h){f(h).css("height",f(h).height())};TextCritical.unfreeze_height=function(h){f(h).css("height","auto")};TextCritical.data_attribute_contains=function(h,k){for(var j=0;j<h.length;j++){attribute=h[j];if(attribute.name.indexOf("data-")==0){if(attribute.value.toLowerCase().indexOf(k)>=0){return true}}}return false};TextCritical.list_filter=function(h,j,i){if(i==undefined){i=false}f(h).change(function(){var k=f(this).val().toLowerCase();if(k){if(i){TextCritical.freeze_height(j)}f(j).find("a").each(function(l){if(f(this).text().toLowerCase().indexOf(k)>=0){f(this).parent().show()}else{if(TextCritical.data_attribute_contains(this.attributes,k)){f(this).parent().show()}else{f(this).parent().hide()}}})}else{f(j).find("li").show();if(i){TextCritical.unfreeze_height(j)}}return false}).keyup(function(){f(this).change()})};TextCritical.resolve_path=function(k,h){var i=null;var j=f.ajax({url:"/api/resolve_reference/?work="+k+"&ref="+h,async:false,success:function(l){i=l.url},type:"GET"});return i};TextCritical.facebookInit=function(){FB.init({appId:"226685657481279",xfbml:true})};TextCritical.getTextToShare=function(i,h){if(i===undefined||i==null){i=""}if(TextCritical.trim(i).length==0||h===true){if(window.getSelection().toString().length>0){i=window.getSelection().toString()}}i=TextCritical.trim(i);i=i.replace(/[ ]*\n[ ]*/g," ");return i};TextCritical.trimTrailingPound=function(h){if(h.slice(-1)=="#"){return h.slice(0,h.length-2)}else{return h}};TextCritical.postToFacebook=function(h,l,j,k,i){if(k===undefined||k==null){k=location.href}if(i===undefined||i==null){i=document.title}l=TextCritical.getTextToShare(l,j);FB.ui({method:"feed",link:TextCritical.trimTrailingPound(k),name:i,caption:h,description:TextCritical.shorten(l,400,true,"...")},function(m){})};TextCritical.makeTweetURL=function(i,j,h){if(i===undefined||i==null){i=location.href}j=TextCritical.getTextToShare(j,h);twitterLink="https://twitter.com/share";data={url:TextCritical.trimTrailingPound(i),text:TextCritical.shorten(j,140-i.length,true,"...")};return twitterLink+"?"+f.param(data)};TextCritical.postToTwitter=function(j,h,i){twitterLink=TextCritical.makeTweetURL(i,j,h);window.open(twitterLink,"_blank")}});