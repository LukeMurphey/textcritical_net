var TextCritical={};TextCritical.setFormatBreakLine=function(){$(".verse_container").addClass("block");$("#align_break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){$(".verse_container").removeClass("block");$("#align_break").removeClass("active")};TextCritical.toggleTOC=function(){$(".table_of_contents").toggle("fast","swing")};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.scrolltoAnchor=function(a){$("html,body").animate({scrollTop:$("#"+a).offset().top},"slow")};TextCritical.scrollToVerse=function(b,a){if(a==null||a==undefined){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var d="verse_"+b;title=document.title;history.pushState({verse:b},title,a+"/"+b);console.info("Updating the URL to point to the selected verse");$(".verse_container").removeClass("highlighted");$(".verse.number").removeClass("label-info");$("#"+d).addClass("highlighted");$("#"+d+" .label").addClass("label-info");TextCritical.scrolltoAnchor(d);return false};TextCritical.loadStoreSettings=function(){var a={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",a);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(a){a=a.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");a=a.replace(/-/gi,"_");a=a.replace(/\s/gi,"-");return a};TextCritical.resolve_path=function(b,d){b=TextCritical.trim(b).toLowerCase();for(c=0;c<d.length;c++){d[c]=d[c].toLowerCase()}var e=window.location.pathname.split("/");var f=[];for(i=0;i<e.length;i++){if(e[i].length>0){f.push(e[i])}if(f.length>=2){break}}divisions_map={};for(c=0;c<d.length;c++){divisions_map[d[c]]=TextCritical.slugify(d[c]);b=b.replace(d[c],TextCritical.slugify(d[c]))}refs=b.split(/[ :._]+/);for(var a in divisions_map){for(c=0;c<refs.length;c++){refs[c]=refs[c].replace(divisions_map[a],a)}}return"/"+f.concat(refs).join("/")};TextCritical.go_to_chapter=function(a,b){document.location=TextCritical.resolve_path(a,b)};TextCritical.word_lookup=function(){work=$("h1[data-work-title-slug]").data("work-title-slug");TextCritical.open_morphology_dialog($(this).text(),work);return false};TextCritical.open_morphology_dialog=function(e,d){console.info("Obtaining the morphology of "+e);e=TextCritical.trim(e);var b=$("#morphology-loading").html();$("#morphology-dialog-content").html(_.template(b,{message:"Looking up morphology for "+_.escape(e)+"..."}));var a='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';$("#morphology-dialog-extra-options").html(_.template(a,{word:e}));$("#morphology-dialog-label").text("Morphology: "+_.escape(e));$("#morphology-dialog").modal();$.ajax({url:"/api/word_parse/"+e}).done(function(g){var f=$("#morphology-info").html();$("#morphology-dialog-content").html(_.template(f,{parses:g,word:_.escape(e),work:d}));$("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+e)}).error(function(f,h,g){$("#morphology-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+e)})};TextCritical.trim=function(a){return String(a).replace(/^\s+|\s+$/g,"")};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word($(this).text())};TextCritical.unhighlight_all_words=function(){$(".word").removeClass("highlighted")};TextCritical.highlight_word=function(b){TextCritical.unhighlight_all_words();var a=new RegExp("^"+b+"$");console.info("Highlighting "+b);$(".word").filter(function(){return a.test($(this).text())}).addClass("highlighted")};TextCritical.contains_search_words=function(a){split_query=a.match(/([_0-9a-z]+[:][-_0-9a-z]+)|([\w_]+[:]["][-\w ]*["])|([^ :]+)/gi);for(c=0;c<split_query.length;c++){if(split_query[c].search(":")<0){return true}}return false};TextCritical.set_caret_at_end=function(d){var b=d.value.length;if(document.selection){d.focus();var a=document.selection.createRange();a.moveStart("character",-b);a.moveStart("character",b);a.moveEnd("character",0);a.select()}else{if(d.selectionStart||d.selectionStart=="0"){d.selectionStart=b;d.selectionEnd=b;d.focus()}}};TextCritical.set_search_url=function(b,a){if(a<=1||parseInt(a)<=1){url=document.location.pathname+"?&q="+b;a=1}else{url=document.location.pathname+"?q="+b+"&page="+a}history.pushState({query:b,page:a},document.title,url)};TextCritical.do_search=function(b,a){word=$("#search-term").val();if(b==undefined||b==null){if($("#page-number").val().length>0){b=parseInt($("#page-number").val());console.info("Getting page from #page-number:"+$("#page-number").val())}else{b=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+b)}if(a==undefined){a=true}if(b<=0){console.warn("Page number is invalid (must be greater than zero)");b=1}$("#search-results-content").attr("data-page-number",b);$("#searching").show();$("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+b+" for "+word);$.ajax({url:"/api/search/?q="+word+"&page="+b}).done(function(d){var e=$("#search-results").html();$("#search-results-content").html(_.template(e,{word:_.escape(word),search_results:d}));if(d.result_count>(d.page*d.page_len)){$(".next-page-link").click(TextCritical.do_search_next)}if(d.page>1){$(".previous-page-link").click(TextCritical.do_search_previous)}$("#search-results-content").unblock();console.info("Successfully searched for "+word);$("#searching").hide();$("#search-results-content").show();if(a){TextCritical.set_search_url(word,b)}}).error(function(d,f,e){$("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+word);$("#searching").hide();$("#search-results-content").show()});return false};TextCritical.do_fresh_search=function(){return TextCritical.do_search(1)};TextCritical.do_search_next=function(){return TextCritical.change_page(1)};TextCritical.change_page=function(a){page=parseInt($("#search-results-content").attr("data-page-number"));if(page==undefined){page=1}else{if(isNaN(page)){console.warn("Page number is invalid");page=1}else{page=page+a}}TextCritical.do_search(page)};TextCritical.do_search_previous=function(){return TextCritical.change_page(-1)};TextCritical.search_page_popstate=function(a){if(a.state==null){return}$("#search-term").val(a.state.query);TextCritical.do_search(a.state.page,false)};TextCritical.convert_search_query_beta_code=function(){query=$("#search-term").val();$.ajax({url:"/api/convert_query_beta_code/?q="+query}).done(function(a){$("#search-term").val(a)})};