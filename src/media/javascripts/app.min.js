var TextCritical={};define(["jquery","underscore","highcharts","libs/text!/media/templates/alert_message.html","libs/text!/media/templates/morphology_dialog.html","libs/text!/media/templates/work_info_dialog.html","libs/text!/media/templates/loading_dialog.html","libs/text!/media/templates/search_results.html","libs/optional!facebook"],function(h,e,a,g,d,f,b,i){TextCritical.setFormatBreakLine=function(){h(".verse-container").addClass("block");h(".align-break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){h(".verse-container").removeClass("block");h(".align-break").removeClass("active")};TextCritical.toggleTOC=function(){if(h(".table-of-contents").is(":visible")){h("#show-table-of-contents-phone").text("Show table of contents")}else{h("#show-table-of-contents-phone").text("Hide table of contents")}h(".table-of-contents").toggle("fast",function(){h(".division-filter").val("");h(".division-filter").change()})};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.escapeIdentifier=function(j){return j.replace(".","\\.")};TextCritical.scrolltoAnchor=function(j){scrollTo=h("#"+j).offset();if(typeof scrollTo=="undefined"){console.warn("The id ("+j+") to scroll to is undefined")}else{h("html,body").animate({scrollTop:scrollTo.top},"slow")}};TextCritical.scrollToVerse=function(l,k){if(typeof k=="undefined"||k==null){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var m="verse-"+l;var j=TextCritical.escapeIdentifier(m);title=document.title;history.pushState({verse:l},title,k+"/"+l+document.location.search);console.info("Updating the URL to point to the selected verse");h(".verse-container").removeClass("highlighted");h(".verse.number").removeClass("label-info");h("#"+j).addClass("highlighted");h("#"+j+" .label").addClass("label-info");TextCritical.scrolltoAnchor(j);return false};TextCritical.loadStoreSettings=function(){var j={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",j);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(j){j=j.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");j=j.replace(/-/gi,"_");j=j.replace(/\s/gi,"-");return j};TextCritical.go_to_chapter=function(j,k){document.location=TextCritical.resolve_path(k,j)};TextCritical.word_lookup=function(){var j=h("h1[data-work-title-slug]").data("work-title-slug");var k=h("#chapter-base-url").data();if(k&&k.chapterDescription){TextCritical.open_morphology_dialog(h(this).text(),j,k.chapterDescription)}else{TextCritical.open_morphology_dialog(h(this).text(),j)}return false};TextCritical.open_dialog=function(m,l,k){if(typeof k=="undefined"||k==null){k=""}h("#popup-dialog-content").html(l);var j='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';h("#popup-dialog-extra-options").html(k);h("#popup-dialog-label").text(m);h("#popup-dialog").modal()};TextCritical.open_morphology_dialog=function(l,k,m){if(typeof m==="undefined"){var m=null}console.info("Obtaining the morphology of "+l);l=TextCritical.trim(l);h("#popup-dialog-content").html(e.template(b,{message:"Looking up morphology for "+e.escape(l)+"..."}));var j='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';h("#popup-dialog-extra-options").html(e.template(j,{word:l}));h("#popup-dialog-label").text("Morphology: "+e.escape(l));h("#popup-dialog").modal();h.ajax({url:"/api/word_parse/"+l}).done(function(n){h("#popup-dialog-content").html(e.template(d,{parses:n,word:e.escape(l),work:k,division:e.escape(m)}));h("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+l)}).error(function(n,p,o){h("#popup-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+l)})};TextCritical.open_topic_dialog=function(k,l,j){if(typeof j==="undefined"){var j=null}if(typeof l==="undefined"){var l=k}console.info("Obtaining information about "+k);l=TextCritical.trim(l);h("#popup-dialog-content").html(e.template(b,{message:"Looking up info for "+e.escape(k)+"..."}));h("#popup-dialog-extra-options").html("");h("#popup-dialog-label").text(e.escape(k));h("#popup-dialog").modal();h.ajax({url:"/api/wikipedia_info/"+l}).done(function(n){n.topic=k;n.success=true;var m='<a target="_blank" class="external" href="<%= url %>">View on wikipedia</a>';h("#popup-dialog-extra-options").html(e.template(m,{url:n.url}));h("#popup-dialog-content").html(e.template(f,n));console.info("Successfully performed a request for information on "+k)}).error(function(m,o,n){if(m.status===404){data={topic:k,success:false};h("#popup-dialog-content").html(e.template(f,data));console.warn("No information could be obtained for "+k)}else{h("#popup-dialog-content").html("<h4>Request failed</h4> The request for information could not be completed");console.error("The request on the topic failed for "+k)}})};TextCritical.trim=function(j){return String(j).replace(/^\s+|\s+$/g,"")};TextCritical.shorten=function(l,p,j,m){if(typeof m=="undefined"||m==null){var m="&hellip;"}if(typeof j=="undefined"||j==null){var j=true}var o=l.length>p,k=o?l.substr(0,p-1):l;k=j&&o?k.substr(0,k.lastIndexOf(" ")):k;return o?k+m:k};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word(h(this).text())};TextCritical.unhighlight_all_words=function(j){if(typeof j=="undefined"){var j="highlighted"}h(".word").removeClass(j)};TextCritical.highlight_word=function(n,m,j){if(typeof m=="undefined"){var m="highlighted"}if(typeof j=="undefined"){var j=true}if(j){TextCritical.unhighlight_all_words(m)}var l=TextCritical.escape_regex(n.normalize());var k=new RegExp("^"+l+"$","i");console.info("Highlighting "+n);h(".word").filter(function(){return k.test(h(this).text().normalize())}).addClass(m)};TextCritical.contains_search_words=function(j){var k=j.match(/([_0-9a-z]+[:][-_0-9a-z]+)|([\w_]+[:]["][-\w ]*["])|([^ :]+)/gi);for(c=0;c<k.length;c++){if(k[c].search(":")<0){return true}}return false};TextCritical.set_caret_at_end=function(l){var k=l.value.length;if(document.selection){l.focus();var j=document.selection.createRange();j.moveStart("character",-k);j.moveStart("character",k);j.moveEnd("character",0);j.select()}else{if(l.selectionStart||l.selectionStart=="0"){l.selectionStart=k;l.selectionEnd=k;l.focus()}}};TextCritical.set_search_url=function(m,l,k,o){if(typeof k==="undefined"){var k=false}if(typeof o==="undefined"){var o=false}var n={};if(related_forms){n.include_related=1}if(o){n.ignore_diacritics=1}if(l<=1||parseInt(l)<=1){n.q=m;l=1}else{n.q=m;n.page=l}var j=document.location.pathname+"?"+h.param(n);history.pushState({query:m,page:l,include_related_forms:k,ignore_diacritics:o},document.title,j)};TextCritical.make_bar_chart=function(n,p,m,j){if(typeof j==="undefined"){j="No data matched"}var k=[];var o=[];if(m){for(var l in m){if(m.hasOwnProperty(l)){k.push(l);o.push(m[l])}}}if(o.length===0){n.html('<div class="alert alert-info alert-block">'+j+"</div>");return false}n.highcharts({colors:["#006dcc"],chart:{type:"bar",backgroundColor:"#2f2f2f",width:h(".tab-pane.active").width()},title:{text:p,style:{color:"#DDD"}},legend:{enabled:false},xAxis:{categories:k,title:{text:null},labels:{style:{color:"#DDD"}},lineColor:"#DDD",tickColor:"#DDD"},yAxis:{min:0,title:{text:"Count",align:"high"},labels:{overflow:"justify",style:{color:"#DDD"}}},plotOptions:{bar:{dataLabels:{enabled:false}}},credits:{enabled:false},series:[{name:"Count",data:o}]})},TextCritical.do_search=function(k,j){var l=h("#search-term").val();if(typeof k=="undefined"||k==null){if(h("#page-number").val().length>0){k=parseInt(h("#page-number").val());console.info("Getting page from #page-number:"+h("#page-number").val())}else{k=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+k)}related_forms=h("#related_forms:checked").length;ignore_diacritics=h("#ignore_diacritics:checked").length;if(typeof j=="undefined"){j=true}if(typeof related_forms=="undefined"){related_forms=0}else{if(!related_forms){related_forms=0}else{related_forms=1}}if(typeof ignore_diacritics=="undefined"){ignore_diacritics=0}else{if(!ignore_diacritics){ignore_diacritics=0}else{ignore_diacritics=1}}if(k<=0){console.warn("Page number is invalid (must be greater than zero)");k=1}h("#search-results-content").attr("data-page-number",k);h("#searching").show();h("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+k+" for "+l);h.ajax({url:"/api/search/"+encodeURIComponent(l)+"?page="+k+"&related_forms="+related_forms+"&ignore_diacritics="+ignore_diacritics}).done(function(m){h("#search-results-content").html(e.template(i,{word:e.escape(l),search_results:m}));if(m.result_count>(m.page*m.page_len)){h(".next-page-link").click(TextCritical.do_search_next)}if(m.page>1){h(".previous-page-link").click(TextCritical.do_search_previous)}h("#search-results-content").unblock();console.info("Successfully searched for "+l);TextCritical.make_bar_chart(h("#chart-word-frequency"),"Frequency of matched words",m.matched_terms,"No data available on matched terms");TextCritical.make_bar_chart(h("#chart-work-frequency"),"Number of matched verses by work",m.matched_works,"No data available on matched works");TextCritical.make_bar_chart(h("#chart-section-frequency"),"Number of matched verses by section",m.matched_sections,"No data available on matched sections");h("#searching").hide();h("#search-results-content").show();if(j){TextCritical.set_search_url(l,k,related_forms,ignore_diacritics)}}).error(function(m,o,n){h("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+l);h("#searching").hide();h("#search-results-content").show()});return false};TextCritical.do_fresh_search=function(){return TextCritical.do_search(1)};TextCritical.do_search_next=function(){return TextCritical.change_page(1)};TextCritical.change_page=function(k){var j=parseInt(h("#search-results-content").attr("data-page-number"));if(typeof j=="undefined"){j=1}else{if(isNaN(j)){console.warn("Page number is invalid");j=1}else{j=j+k}}TextCritical.do_search(j)};TextCritical.search_this_work=function(){var j=h("h1[data-work-title-slug]").data("work-title-slug");var l="/search?q=work:"+j;var k=h("#chapter-base-url").data();if(k){l+=' section:"'+k.chapterDescription+'"'}document.location=l;return false};TextCritical.do_search_previous=function(){return TextCritical.change_page(-1)};TextCritical.search_page_popstate=function(j){if(j.state==null){return}h("#search-term").val(j.state.query);TextCritical.do_search(j.state.page,false)};TextCritical.convert_search_query_beta_code=function(){var j=h("#search-term").val();h.ajax({url:"/api/convert_query_beta_code/?q="+j}).done(function(k){h("#search-term").val(k)})};TextCritical.add_word_morphology_links=function(j,m){if(typeof m==="undefined"){var m=j.text()}var l=m.split(" ");j.text("");for(var k=0;k<l.length;k++){j.append('<span class="word">'+l[k]+" </span>")}};TextCritical.get_related_forms=function(){query=encodeURIComponent(h("#text").val());h.ajax({url:"/api/word_forms/"+query}).done(function(j){h("#output").text(j.forms.join(", ").toLowerCase())})};TextCritical.flatten_typeahead_hints=function(k){hints_flattened=[];for(var j=0;j<k.length;j++){if(e.indexOf(hints_flattened,k[j].desc)<0){hints_flattened.push(k[j].desc)}}return hints_flattened};TextCritical.works_search_typeahead_hints=[];TextCritical.works_search_typeahead_hints_flattened=[];TextCritical.get_works_search_typeahead_hints=function(j){var l=jQuery.Deferred();if(typeof j=="undefined"){var j=true}if(TextCritical.works_search_typeahead_hints_flattened.length>0){console.info("Type-ahead hints already available via the cache");if(j){l.resolve(TextCritical.works_search_typeahead_hints_flattened)}else{l.resolve(TextCritical.works_search_typeahead_hints)}}else{console.info("Retrieving list of typeahead hints from the server");var l=jQuery.Deferred();var k=h.ajax({url:"/api/works_typeahead_hints",success:function(m){TextCritical.works_search_typeahead_hints=m;TextCritical.works_search_typeahead_hints_flattened=TextCritical.flatten_typeahead_hints(TextCritical.works_search_typeahead_hints);if(j){l.resolve(TextCritical.works_search_typeahead_hints_flattened)}else{l.resolve(TextCritical.works_search_typeahead_hints)}},type:"GET"})}return l};TextCritical.jump_to_searched_text=function(j){list=TextCritical.works_search_typeahead_hints;found=0;url=null;for(var k=0;k<list.length;k++){if(list[k].desc==j){found=found+1;url=list[k].url}}if(found>1||found==0||url==null||url==""){return false}else{location=url;return true}};TextCritical.show_alert=function(k,j,l){if(typeof l=="undefined"||l==null){l="info"}h("#messages").append(e.template(g,{title:e.escape(k),message:e.escape(j),level:l}))};TextCritical.update_work_url=function(j){if(location.pathname!==j){console.info("Updating the URL to reflect the canonical URL");title=document.title;history.replaceState({},title,j);TextCritical.show_alert("Stale URL","The URL you were using was old so redirected to the new one. You may want to update your shortcuts.","info")}};TextCritical.get_note_content=function(l,k,j){if(typeof k==undefined||k==null){var k=false}if(k>0){content=TextCritical.shorten(h("#content_for_"+l).text(),k,true,j)}else{content=h("#content_for_"+l).html()}return content};TextCritical.get_note_title=function(j){note_number=h("#"+j).attr("data-note-number");if(note_number!=null){return"Note "+note_number}else{return"Note"}};TextCritical.open_note_dialog=function(j){title=TextCritical.get_note_title(h(this).attr("id"));content=TextCritical.get_note_content(h(this).attr("id"));TextCritical.open_dialog(title,content);return false};TextCritical.escape_regex=function(j){return j.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")};TextCritical.highlight_searched_terms=function(){var j=TextCritical.get_parameter_by_name(document.location.search,"highlight",true);if(j!==undefined){for(var k=0;k<j.length;k++){TextCritical.highlight_word(decodeURIComponent(j[k]),"searched",false)}}};TextCritical.get_parameter_by_name=function(l,k,o){if(typeof o=="undefined"){var o=false}k=k.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var n=new RegExp("[\\?&]"+k+"(=([^&#]*))?","g");var m;var j=[];while(m=n.exec(l)){if(m[2]!==undefined){j.push(m[2].replace(/\+/g," "))}else{j.push("")}if(!o){return j[0]}}if(j.length==0){return undefined}else{return j}};TextCritical.add_async_parameter=function(j){if(TextCritical.get_parameter_by_name(j,"async")!==undefined){}else{if(j.indexOf("?")>0){j=j+"&async"}else{j=j+"?async"}}return j};TextCritical.load_ajah=function(j){j=TextCritical.add_async_parameter(j);h.ajax({url:j,success:function(k){console.info("Loading page content with asynchronous request");h("#main-content").html(k).fadeIn("slow");h("#async-loading-message").hide();console.info("Sucessfully loaded page content with asynchronous request")},error:function(k,m,l){console.error("Failed to load the page content with asynchronous request");h("#main-content").html("<h3>Yikes! That didn't work</h3>I'm sorry, but the content couldn't be loaded").fadeIn("slow");h("#async-loading-message").hide()}})};TextCritical.pre_load_next_link=function(){next_href=h("link[rel=next]").attr("href");if(next_href!==undefined){next_href=TextCritical.add_async_parameter(next_href);console.info("Beginning request to cache content of the next chapter ("+next_href+")");h.ajax({url:next_href}).done(function(j){console.info("Successfully cached the contents of the next chapter at "+next_href)}).error(function(j,l,k){console.error("Request for next chapter's content failed (url attempted was "+next_href+")")})}};TextCritical.convert_search_query_beta_code=function(j){converted_beta_code=null;h.ajax({async:false,url:"/api/beta_code_to_unicode/?text="+j}).done(function(k){converted_beta_code=k.unicode});return converted_beta_code};TextCritical.freeze_height=function(j){h(j).css("height",h(j).height())};TextCritical.unfreeze_height=function(j){h(j).css("height","auto")};TextCritical.data_attribute_contains=function(j,l){for(var k=0;k<j.length;k++){attribute=j[k];if(attribute.name.indexOf("data-")==0){if(attribute.value.toLowerCase().indexOf(l)>=0){return true}}}return false};TextCritical.list_filter=function(j,l,k){if(typeof k=="undefined"){var k=false}h(j).change(function(){var m=h(this).val().toLowerCase();if(m){if(k){TextCritical.freeze_height(l)}h(l).find("a").each(function(n){if(h(this).text().toLowerCase().indexOf(m)>=0){h(this).parent().show()}else{if(TextCritical.data_attribute_contains(this.attributes,m)){h(this).parent().show()}else{h(this).parent().hide()}}})}else{h(l).find("li").show();if(k){TextCritical.unfreeze_height(l)}}return false}).keyup(function(){h(this).change()})};TextCritical.resolve_path=function(m,j){var k=null;var l=h.ajax({url:"/api/resolve_reference/?work="+m+"&ref="+j,async:false,success:function(n){k=n.url},type:"GET"});return k};TextCritical.facebookInit=function(){if(typeof FB!=="undefined"){FB.init({appId:"226685657481279",xfbml:true})}};TextCritical.getTextToShare=function(k,j){if(typeof k==="undefined"||k==null){var k=""}if(TextCritical.trim(k).length==0||j===true){if(window.getSelection().toString().length>0){k=window.getSelection().toString()}}k=TextCritical.trim(k);k=k.replace(/[ ]*\n[ ]*/g," ");return k};TextCritical.trimTrailingPound=function(j){if(j.slice(-1)=="#"){return j.slice(0,j.length-2)}else{return j}};TextCritical.postToFacebook=function(j,n,l,m,k){if(typeof m==="undefined"||m==null){var m=location.href}if(typeof k==="undefined"||k==null){var k=document.title}n=TextCritical.getTextToShare(n,l);FB.ui({method:"feed",link:TextCritical.trimTrailingPound(m),name:k,caption:j,description:TextCritical.shorten(n,400,true,"...")},function(o){})};TextCritical.makeTweetURL=function(k,l,j){if(typeof k==="undefined"||k==null){var k=location.href}l=TextCritical.getTextToShare(l,j);twitterLink="https://twitter.com/share";data={url:TextCritical.trimTrailingPound(k),text:TextCritical.shorten(l,140-k.length,true,"...")};return twitterLink+"?"+h.param(data)};TextCritical.postToTwitter=function(l,j,k){twitterLink=TextCritical.makeTweetURL(k,l,j);window.open(twitterLink,"_blank")};TextCritical.serialize=function(k){var l=[];for(var j in k){l.push(encodeURIComponent(j)+"="+encodeURIComponent(k[j]))}return l.join("&")};TextCritical.sendAnEmail=function(l,j,k,m){if(m===undefined||m==null){m=location.href}if(l===undefined||m==null){l=document.title}j=TextCritical.getTextToShare(j,k);data={subject:l,body:TextCritical.shorten(j,1000,true,"...")+"\n\n[Source: "+TextCritical.trimTrailingPound(m)+"]",};document.location.href="mailto:?"+TextCritical.serialize(data)};TextCritical.pollForShareButtons=function(){if(h("iframe",".sharing-buttons").length<2){setTimeout(TextCritical.pollForShareButtons,200)}else{setTimeout(function(){h(".sharing-buttons").fadeIn()},1500)}}});