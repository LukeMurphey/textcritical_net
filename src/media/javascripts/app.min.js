var TextCritical={};define(["jquery","underscore","libs/text!/media/templates/alert_message.html","libs/text!/media/templates/morphology_dialog.html","libs/text!/media/templates/loading_dialog.html","libs/text!/media/templates/search_results.html"],function(f,d,e,b,a,g){TextCritical.setFormatBreakLine=function(){f(".verse-container").addClass("block");f(".align-break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){f(".verse-container").removeClass("block");f(".align-break").removeClass("active")};TextCritical.toggleTOC=function(){if(f(".table-of-contents").is(":visible")){f("#show-table-of-contents-phone").text("Show table of contents")}else{f("#show-table-of-contents-phone").text("Hide table of contents")}f(".table-of-contents").toggle("fast","swing")};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.escapeIdentifier=function(h){return h.replace(".","\\.")};TextCritical.scrolltoAnchor=function(h){scrollTo=f("#"+h).offset();if(scrollTo==undefined){console.warn("The id ("+h+") to scroll to is undefined")}else{f("html,body").animate({scrollTop:scrollTo.top},"slow")}};TextCritical.scrollToVerse=function(k,j){if(j==null||j==undefined){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var l="verse-"+k;var h=TextCritical.escapeIdentifier(l);title=document.title;history.pushState({verse:k},title,j+"/"+k);console.info("Updating the URL to point to the selected verse");f(".verse-container").removeClass("highlighted");f(".verse.number").removeClass("label-info");f("#"+h).addClass("highlighted");f("#"+h+" .label").addClass("label-info");TextCritical.scrolltoAnchor(h);return false};TextCritical.loadStoreSettings=function(){var h={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",h);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(h){h=h.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");h=h.replace(/-/gi,"_");h=h.replace(/\s/gi,"-");return h};TextCritical.resolve_path=function(j,k){j=TextCritical.trim(j).toLowerCase();for(c=0;c<k.length;c++){k[c]=k[c].toLowerCase()}var l=window.location.pathname.split("/");var m=[];for(i=0;i<l.length;i++){if(l[i].length>0){m.push(l[i])}if(m.length>=2){break}}divisions_map={};for(c=0;c<k.length;c++){divisions_map[k[c]]=TextCritical.slugify(k[c]);j=j.replace(k[c],TextCritical.slugify(k[c]))}refs=j.split(/[ :._]+/);for(var h in divisions_map){for(c=0;c<refs.length;c++){refs[c]=refs[c].replace(divisions_map[h],h)}}return"/"+m.concat(refs).join("/")};TextCritical.go_to_chapter=function(h,j){document.location=TextCritical.resolve_path(h,j)};TextCritical.word_lookup=function(){work=f("h1[data-work-title-slug]").data("work-title-slug");TextCritical.open_morphology_dialog(f(this).text(),work);return false};TextCritical.open_dialog=function(l,k,j){if(j==null||j==undefined){j=""}f("#popup-dialog-content").html(k);var h='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';f("#popup-dialog-extra-options").html(j);f("#popup-dialog-label").text(l);f("#popup-dialog").modal()};TextCritical.open_morphology_dialog=function(k,j){console.info("Obtaining the morphology of "+k);k=TextCritical.trim(k);f("#popup-dialog-content").html(d.template(a,{message:"Looking up morphology for "+d.escape(k)+"..."}));var h='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';f("#popup-dialog-extra-options").html(d.template(h,{word:k}));f("#popup-dialog-label").text("Morphology: "+d.escape(k));f("#popup-dialog").modal();f.ajax({url:"/api/word_parse/"+k}).done(function(l){f("#popup-dialog-content").html(d.template(b,{parses:l,word:d.escape(k),work:j}));f("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+k)}).error(function(l,n,m){f("#popup-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+k)})};TextCritical.trim=function(h){return String(h).replace(/^\s+|\s+$/g,"")};TextCritical.shorten=function(k,o,h,l){if(l==undefined||l==null){l="&hellip;"}if(h==undefined||h==null){h=true}var m=k.length>o,j=m?k.substr(0,o-1):k;j=h&&m?j.substr(0,j.lastIndexOf(" ")):j;return m?j+l:j};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word(f(this).text())};TextCritical.unhighlight_all_words=function(){f(".word").removeClass("highlighted")};TextCritical.highlight_word=function(j){TextCritical.unhighlight_all_words();escaped_word=TextCritical.escape_regex(j);var h=new RegExp("^"+escaped_word+"$");console.info("Highlighting "+j);f(".word").filter(function(){return h.test(f(this).text())}).addClass("highlighted")};TextCritical.contains_search_words=function(h){split_query=h.match(/([_0-9a-z]+[:][-_0-9a-z]+)|([\w_]+[:]["][-\w ]*["])|([^ :]+)/gi);for(c=0;c<split_query.length;c++){if(split_query[c].search(":")<0){return true}}return false};TextCritical.set_caret_at_end=function(k){var j=k.value.length;if(document.selection){k.focus();var h=document.selection.createRange();h.moveStart("character",-j);h.moveStart("character",j);h.moveEnd("character",0);h.select()}else{if(k.selectionStart||k.selectionStart=="0"){k.selectionStart=j;k.selectionEnd=j;k.focus()}}};TextCritical.set_search_url=function(j,h){if(h<=1||parseInt(h)<=1){url=document.location.pathname+"?&q="+j;h=1}else{url=document.location.pathname+"?q="+j+"&page="+h}history.pushState({query:j,page:h},document.title,url)};TextCritical.do_search=function(j,h){word=f("#search-term").val();if(j==undefined||j==null){if(f("#page-number").val().length>0){j=parseInt(f("#page-number").val());console.info("Getting page from #page-number:"+f("#page-number").val())}else{j=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+j)}related_forms=f("#related_forms:checked").length;if(h==undefined){h=true}if(related_forms==undefined){related_forms=0}else{if(!related_forms){related_forms=0}else{related_forms=1}}if(j<=0){console.warn("Page number is invalid (must be greater than zero)");j=1}f("#search-results-content").attr("data-page-number",j);f("#searching").show();f("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+j+" for "+word);f.ajax({url:"/api/search/?q="+encodeURIComponent(word)+"&page="+j+"&related_forms="+related_forms}).done(function(k){f("#search-results-content").html(d.template(g,{word:d.escape(word),search_results:k}));if(k.result_count>(k.page*k.page_len)){f(".next-page-link").click(TextCritical.do_search_next)}if(k.page>1){f(".previous-page-link").click(TextCritical.do_search_previous)}f("#search-results-content").unblock();console.info("Successfully searched for "+word);f("#searching").hide();f("#search-results-content").show();if(h){TextCritical.set_search_url(word,j)}}).error(function(k,m,l){f("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+word);f("#searching").hide();f("#search-results-content").show()});return false};TextCritical.show_search_help=function(h){if(h==undefined){h=true}if(h){f("#search-help").show();f("#search-results-content").hide()}else{f("#search-help").hide();f("#search-results-content").show()}};TextCritical.toggle_search_help=function(){if(f("#search-help").is(":visible")){TextCritical.show_search_help(false)}else{TextCritical.show_search_help(true)}return false};TextCritical.do_fresh_search=function(){TextCritical.show_search_help(false);return TextCritical.do_search(1)};TextCritical.do_search_next=function(){return TextCritical.change_page(1)};TextCritical.change_page=function(h){page=parseInt(f("#search-results-content").attr("data-page-number"));if(page==undefined){page=1}else{if(isNaN(page)){console.warn("Page number is invalid");page=1}else{page=page+h}}TextCritical.do_search(page)};TextCritical.search_this_work=function(){work=f("h1[data-work-title-slug]").data("work-title-slug");search_uri="/search?q=work:"+work;document.location=search_uri;return false};TextCritical.do_search_previous=function(){return TextCritical.change_page(-1)};TextCritical.search_page_popstate=function(h){if(h.state==null){return}f("#search-term").val(h.state.query);TextCritical.do_search(h.state.page,false)};TextCritical.convert_search_query_beta_code=function(){query=f("#search-term").val();f.ajax({url:"/api/convert_query_beta_code/?q="+query}).done(function(h){f("#search-term").val(h)})};TextCritical.works_search_typeahead_hints=[];TextCritical.get_works_search_typeahead_hints=function(){if(TextCritical.works_search_typeahead_hints.length>0){return TextCritical.works_search_typeahead_hints}else{console.info("Retrieving list of typeahead hints from the server");var h=f.ajax({url:"/api/works_typehead_hints",async:false,success:function(j){TextCritical.works_search_typeahead_hints=j},type:"GET"});return TextCritical.works_search_typeahead_hints}};TextCritical.show_alert=function(j,h,k){if(k==undefined||k==null){k="info"}f("#messages").append(d.template(e,{title:d.escape(j),message:d.escape(h),level:k}))};TextCritical.update_work_url=function(h){if(location.pathname!==h){console.info("Updating the URL to reflect the canonical URL");title=document.title;history.replaceState({},title,h);TextCritical.show_alert("Stale URL","The URL you were using was old so redirected to the new one. You may want to update your shortcuts.","info")}};TextCritical.get_note_content=function(k,j,h){if(j==undefined||j==null){j=false}if(j>0){content=TextCritical.shorten(f("#content_for_"+k).text(),j,true,h)}else{content=f("#content_for_"+k).html()}return content};TextCritical.get_note_title=function(h){note_number=f("#"+h).attr("data-note-number");if(note_number!=null){return"Note "+note_number}else{return"Note"}};TextCritical.open_note_dialog=function(h){title=TextCritical.get_note_title(f(this).attr("id"));content=TextCritical.get_note_content(f(this).attr("id"));TextCritical.open_dialog(title,content);return false};TextCritical.escape_regex=function(h){return h.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")};TextCritical.get_parameter_by_name=function(j,h){h=h.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var l=new RegExp("[\\?&]"+h+"(=([^&#]*))?"),k=l.exec(j);if(k==null){return undefined}else{if(k[2]!==undefined){return k[2].replace(/\+/g," ")}else{return""}}};TextCritical.load_ajah=function(h){if(TextCritical.get_parameter_by_name(h,"async")!==undefined){}else{if(h.indexOf("?")>0){h=h+"&async"}else{h=h+"?async"}}f.ajax({url:h,success:function(j){console.info("Loading page content with asynchronous request");f("#main-content").html(j).fadeIn("slow");f("#async-loading-message").hide();console.info("Sucessfully loaded page content with asynchronous request")},error:function(j,l,k){console.error("Failed to load the page content with asynchronous request");f("#main-content").html("<h3>Yikes! That didn't work</h3>I'm sorry, but the content couldn't be loaded")}})};TextCritical.setup_link_handlers_for_ios_web_apps=function(){if(("standalone" in window.navigator)&&window.navigator.standalone){f(document).on("click","a",function(j){var h=f(this).attr("href");if(j.target.target!="_blank"&&(h.indexOf(location.hostname)>-1||h.indexOf("http")!=0)){j.preventDefault();var k=h;if(k!=undefined&&k.substr(0,1)!="#"&&f(this).attr("data-method")==undefined){window.location=k}}})}}});