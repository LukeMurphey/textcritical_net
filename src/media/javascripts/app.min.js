var TextCritical={};define(["jquery","underscore","highcharts","libs/text!/media/templates/alert_message.html","libs/text!/media/templates/morphology_dialog.html","libs/text!/media/templates/loading_dialog.html","libs/text!/media/templates/search_results.html","facebook"],function(g,e,a,f,d,b,h){TextCritical.setFormatBreakLine=function(){g(".verse-container").addClass("block");g(".align-break").addClass("active")};TextCritical.unSetFormatBreakLine=function(){g(".verse-container").removeClass("block");g(".align-break").removeClass("active")};TextCritical.toggleTOC=function(){if(g(".table-of-contents").is(":visible")){g("#show-table-of-contents-phone").text("Show table of contents")}else{g("#show-table-of-contents-phone").text("Hide table of contents")}g(".table-of-contents").toggle("fast",function(){g(".division-filter").val("");g(".division-filter").change()})};TextCritical.toggleVerseBreak=function(){break_verses=!break_verses;if(break_verses){TextCritical.setFormatBreakLine()}else{TextCritical.unSetFormatBreakLine()}settings.set("break_verses",break_verses)};TextCritical.escapeIdentifier=function(i){return i.replace(".","\\.")};TextCritical.scrolltoAnchor=function(i){scrollTo=g("#"+i).offset();if(typeof scrollTo=="undefined"){console.warn("The id ("+i+") to scroll to is undefined")}else{g("html,body").animate({scrollTop:scrollTo.top},"slow")}};TextCritical.scrollToVerse=function(k,j){if(typeof j=="undefined"||j==null){console.warn("No base chapter URL was provided; will not be able to update the URL for the given verse");return true}var l="verse-"+k;var i=TextCritical.escapeIdentifier(l);title=document.title;history.pushState({verse:k},title,j+"/"+k+document.location.search);console.info("Updating the URL to point to the selected verse");g(".verse-container").removeClass("highlighted");g(".verse.number").removeClass("label-info");g("#"+i).addClass("highlighted");g("#"+i+" .label").addClass("label-info");TextCritical.scrolltoAnchor(i);return false};TextCritical.loadStoreSettings=function(){var i={break_verses:false};settings=new Store("settings");break_verses=settings.get("break_verses",i);if(break_verses){TextCritical.setFormatBreakLine()}};TextCritical.slugify=function(i){i=i.replace(/[^-a-zA-Z0-9,&\s]+/ig,"");i=i.replace(/-/gi,"_");i=i.replace(/\s/gi,"-");return i};TextCritical.go_to_chapter=function(i,j){document.location=TextCritical.resolve_path(j,i)};TextCritical.word_lookup=function(){var i=g("h1[data-work-title-slug]").data("work-title-slug");var j=g("#chapter-base-url").data();if(j&&j.chapterDescription){TextCritical.open_morphology_dialog(g(this).text(),i,j.chapterDescription)}else{TextCritical.open_morphology_dialog(g(this).text(),i)}return false};TextCritical.open_dialog=function(l,k,j){if(typeof j=="undefined"||j==null){j=""}g("#popup-dialog-content").html(k);var i='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';g("#popup-dialog-extra-options").html(j);g("#popup-dialog-label").text(l);g("#popup-dialog").modal()};TextCritical.open_morphology_dialog=function(k,j,l){if(typeof l==="undefined"){var l=null}console.info("Obtaining the morphology of "+k);k=TextCritical.trim(k);g("#popup-dialog-content").html(e.template(b,{message:"Looking up morphology for "+e.escape(k)+"..."}));var i='Look up at <a target="_blank" href="http://www.perseus.tufts.edu/hopper/morph?l=<%= word %>&la=greek">Perseus</a> or <a target="_blank" href="https://www.google.com/search?q=<%= word %>">Google</a>';g("#popup-dialog-extra-options").html(e.template(i,{word:k}));g("#popup-dialog-label").text("Morphology: "+e.escape(k));g("#popup-dialog").modal();g.ajax({url:"/api/word_parse/"+k}).done(function(m){g("#popup-dialog-content").html(e.template(d,{parses:m,word:e.escape(k),work:j,division:e.escape(l)}));g("a.lemma").click(TextCritical.word_lookup);console.info("Successfully performed a request for the morphology of "+k)}).error(function(m,o,n){g("#popup-dialog-content").html("<h4>Parse failed</h4> The request to parse could not be completed");console.error("The request for the morphology failed for "+k)})};TextCritical.trim=function(i){return String(i).replace(/^\s+|\s+$/g,"")};TextCritical.shorten=function(k,o,i,l){if(typeof l=="undefined"||l==null){var l="&hellip;"}if(typeof i=="undefined"||i==null){var i=true}var m=k.length>o,j=m?k.substr(0,o-1):k;j=i&&m?j.substr(0,j.lastIndexOf(" ")):j;return m?j+l:j};TextCritical.highlight_selected_word=function(){TextCritical.highlight_word(g(this).text())};TextCritical.unhighlight_all_words=function(i){if(typeof i=="undefined"){var i="highlighted"}g(".word").removeClass(i)};TextCritical.highlight_word=function(m,l,i){if(typeof l=="undefined"){var l="highlighted"}if(typeof i=="undefined"){var i=true}if(i){TextCritical.unhighlight_all_words(l)}var k=TextCritical.escape_regex(m.normalize());var j=new RegExp("^"+k+"$","i");console.info("Highlighting "+m);g(".word").filter(function(){return j.test(g(this).text().normalize())}).addClass(l)};TextCritical.contains_search_words=function(i){var j=i.match(/([_0-9a-z]+[:][-_0-9a-z]+)|([\w_]+[:]["][-\w ]*["])|([^ :]+)/gi);for(c=0;c<j.length;c++){if(j[c].search(":")<0){return true}}return false};TextCritical.set_caret_at_end=function(k){var j=k.value.length;if(document.selection){k.focus();var i=document.selection.createRange();i.moveStart("character",-j);i.moveStart("character",j);i.moveEnd("character",0);i.select()}else{if(k.selectionStart||k.selectionStart=="0"){k.selectionStart=j;k.selectionEnd=j;k.focus()}}};TextCritical.set_search_url=function(l,k,j){var i=document.location.pathname+"?";if(related_forms){i+="include_related=1"}if(k<=1||parseInt(k)<=1){i+="&q="+l;k=1}else{i+="&q="+l+"&page="+k}history.pushState({query:l,page:k,include_related_forms:j},document.title,i)};TextCritical.make_bar_chart=function(m,o,l,i){if(typeof i==="undefined"){i="No data matched"}var j=[];var n=[];if(l){for(var k in l){if(l.hasOwnProperty(k)){j.push(k);n.push(l[k])}}}if(n.length===0){m.html('<div class="alert alert-info alert-block">'+i+"</div>");return false}m.highcharts({colors:["#006dcc"],chart:{type:"bar",backgroundColor:"#2f2f2f",width:g(".tab-pane.active").width()},title:{text:o,style:{color:"#DDD"}},legend:{enabled:false},xAxis:{categories:j,title:{text:null},labels:{style:{color:"#DDD"}},lineColor:"#DDD",tickColor:"#DDD"},yAxis:{min:0,title:{text:"Count",align:"high"},labels:{overflow:"justify",style:{color:"#DDD"}}},plotOptions:{bar:{dataLabels:{enabled:false}}},credits:{enabled:false},series:[{name:"Count",data:n}]})},TextCritical.do_search=function(j,i){var k=g("#search-term").val();if(typeof j=="undefined"||j==null){if(g("#page-number").val().length>0){j=parseInt(g("#page-number").val());console.info("Getting page from #page-number:"+g("#page-number").val())}else{j=1;console.info("Setting page to 1")}}else{console.info("Using provided page: "+j)}related_forms=g("#related_forms:checked").length;if(typeof i=="undefined"){i=true}if(typeof related_forms=="undefined"){related_forms=0}else{if(!related_forms){related_forms=0}else{related_forms=1}}if(j<=0){console.warn("Page number is invalid (must be greater than zero)");j=1}g("#search-results-content").attr("data-page-number",j);g("#searching").show();g("#search-results-content").block({message:null,overlayCSS:{backgroundColor:"#2f2f2f",opacity:0.8}});console.info("Executing search on page "+j+" for "+k);g.ajax({url:"/api/search/"+encodeURIComponent(k)+"?page="+j+"&related_forms="+related_forms}).done(function(l){g("#search-results-content").html(e.template(h,{word:e.escape(k),search_results:l}));if(l.result_count>(l.page*l.page_len)){g(".next-page-link").click(TextCritical.do_search_next)}if(l.page>1){g(".previous-page-link").click(TextCritical.do_search_previous)}g("#search-results-content").unblock();console.info("Successfully searched for "+k);TextCritical.make_bar_chart(g("#chart-word-frequency"),"Frequency of matched words",l.matched_terms,"No data available on matched terms");TextCritical.make_bar_chart(g("#chart-work-frequency"),"Number of matched verses by work",l.matched_works,"No data available on matched works");TextCritical.make_bar_chart(g("#chart-section-frequency"),"Number of matched verses by section",l.matched_sections,"No data available on matched sections");g("#searching").hide();g("#search-results-content").show();if(i){TextCritical.set_search_url(k,j,related_forms)}}).error(function(l,n,m){g("#search-results-content").html("<h4>Search failed</h4> The search request could not be completed");console.error("The request to search failed for "+k);g("#searching").hide();g("#search-results-content").show()});return false};TextCritical.do_fresh_search=function(){return TextCritical.do_search(1)};TextCritical.do_search_next=function(){return TextCritical.change_page(1)};TextCritical.change_page=function(j){var i=parseInt(g("#search-results-content").attr("data-page-number"));if(typeof i=="undefined"){i=1}else{if(isNaN(i)){console.warn("Page number is invalid");i=1}else{i=i+j}}TextCritical.do_search(i)};TextCritical.search_this_work=function(){var i=g("h1[data-work-title-slug]").data("work-title-slug");var k="/search?q=work:"+i;var j=g("#chapter-base-url").data();if(j){k+=' section:"'+j.chapterDescription+'"'}document.location=k;return false};TextCritical.do_search_previous=function(){return TextCritical.change_page(-1)};TextCritical.search_page_popstate=function(i){if(i.state==null){return}g("#search-term").val(i.state.query);TextCritical.do_search(i.state.page,false)};TextCritical.convert_search_query_beta_code=function(){var i=g("#search-term").val();g.ajax({url:"/api/convert_query_beta_code/?q="+i}).done(function(j){g("#search-term").val(j)})};TextCritical.add_word_morphology_links=function(j,m){if(typeof m==="undefined"){var m=j.text()}var l=m.split(" ");j.text("");for(var k=0;k<l.length;k++){j.append('<span class="word">'+l[k]+" </span>")}};TextCritical.get_related_forms=function(){query=encodeURIComponent(g("#text").val());g.ajax({url:"/api/word_forms/"+query}).done(function(i){g("#output").text(i.forms.join(", ").toLowerCase())})};TextCritical.flatten_typeahead_hints=function(k){hints_flattened=[];for(var j=0;j<k.length;j++){if(e.indexOf(hints_flattened,k[j].desc)<0){hints_flattened.push(k[j].desc)}}return hints_flattened};TextCritical.works_search_typeahead_hints=[];TextCritical.works_search_typeahead_hints_flattened=[];TextCritical.get_works_search_typeahead_hints=function(i){var k=jQuery.Deferred();if(typeof i=="undefined"){var i=true}if(TextCritical.works_search_typeahead_hints_flattened.length>0){console.info("Type-ahead hints already available via the cache");if(i){k.resolve(TextCritical.works_search_typeahead_hints_flattened)}else{k.resolve(TextCritical.works_search_typeahead_hints)}}else{console.info("Retrieving list of typeahead hints from the server");var k=jQuery.Deferred();var j=g.ajax({url:"/api/works_typeahead_hints",success:function(l){TextCritical.works_search_typeahead_hints=l;TextCritical.works_search_typeahead_hints_flattened=TextCritical.flatten_typeahead_hints(TextCritical.works_search_typeahead_hints);if(i){k.resolve(TextCritical.works_search_typeahead_hints_flattened)}else{k.resolve(TextCritical.works_search_typeahead_hints)}},type:"GET"})}return k};TextCritical.jump_to_searched_text=function(i){list=TextCritical.works_search_typeahead_hints;found=0;url=null;for(var j=0;j<list.length;j++){if(list[j].desc==i){found=found+1;url=list[j].url}}if(found>1||found==0||url==null||url==""){return false}else{location=url;return true}};TextCritical.show_alert=function(j,i,k){if(typeof k=="undefined"||k==null){k="info"}g("#messages").append(e.template(f,{title:e.escape(j),message:e.escape(i),level:k}))};TextCritical.update_work_url=function(i){if(location.pathname!==i){console.info("Updating the URL to reflect the canonical URL");title=document.title;history.replaceState({},title,i);TextCritical.show_alert("Stale URL","The URL you were using was old so redirected to the new one. You may want to update your shortcuts.","info")}};TextCritical.get_note_content=function(k,j,i){if(typeof j==undefined||j==null){var j=false}if(j>0){content=TextCritical.shorten(g("#content_for_"+k).text(),j,true,i)}else{content=g("#content_for_"+k).html()}return content};TextCritical.get_note_title=function(i){note_number=g("#"+i).attr("data-note-number");if(note_number!=null){return"Note "+note_number}else{return"Note"}};TextCritical.open_note_dialog=function(i){title=TextCritical.get_note_title(g(this).attr("id"));content=TextCritical.get_note_content(g(this).attr("id"));TextCritical.open_dialog(title,content);return false};TextCritical.escape_regex=function(i){return i.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")};TextCritical.highlight_searched_terms=function(){var i=TextCritical.get_parameter_by_name(document.location.search,"highlight",true);for(var j=0;j<i.length;j++){TextCritical.highlight_word(decodeURIComponent(i[j]),"searched",false)}};TextCritical.get_parameter_by_name=function(k,j,n){if(typeof n=="undefined"){var n=false}j=j.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var m=new RegExp("[\\?&]"+j+"(=([^&#]*))?","g");var l;var i=[];while(l=m.exec(k)){if(l[2]!==undefined){i.push(l[2].replace(/\+/g," "))}else{i.push("")}if(!n){return i[0]}}if(i.length==0){return undefined}else{return i}};TextCritical.add_async_parameter=function(i){if(TextCritical.get_parameter_by_name(i,"async")!==undefined){}else{if(i.indexOf("?")>0){i=i+"&async"}else{i=i+"?async"}}return i};TextCritical.load_ajah=function(i){i=TextCritical.add_async_parameter(i);g.ajax({url:i,success:function(j){console.info("Loading page content with asynchronous request");g("#main-content").html(j).fadeIn("slow");g("#async-loading-message").hide();console.info("Sucessfully loaded page content with asynchronous request")},error:function(j,l,k){console.error("Failed to load the page content with asynchronous request");g("#main-content").html("<h3>Yikes! That didn't work</h3>I'm sorry, but the content couldn't be loaded").fadeIn("slow");g("#async-loading-message").hide()}})};TextCritical.setup_link_handlers_for_ios_web_apps=function(){if(("standalone" in window.navigator)&&window.navigator.standalone){g(document).on("click","a",function(j){var i=g(this).attr("href");if(j.target.target!="_blank"&&(i.indexOf(location.hostname)>-1||i.indexOf("http")!=0)){j.preventDefault();var k=i;if(k!=undefined&&k.substr(0,1)!="#"&&g(this).attr("data-method")==undefined){window.location=k}}})}};TextCritical.pre_load_next_link=function(){next_href=g("link[rel=next]").attr("href");if(next_href!==undefined){next_href=TextCritical.add_async_parameter(next_href);console.info("Beginning request to cache content of the next chapter ("+next_href+")");g.ajax({url:next_href}).done(function(i){console.info("Successfully cached the contents of the next chapter at "+next_href)}).error(function(i,k,j){console.error("Request for next chapter's content failed (url attempted was "+next_href+")")})}};TextCritical.convert_search_query_beta_code=function(i){converted_beta_code=null;g.ajax({async:false,url:"/api/beta_code_to_unicode/?text="+i}).done(function(j){converted_beta_code=j.unicode});return converted_beta_code};TextCritical.freeze_height=function(i){g(i).css("height",g(i).height())};TextCritical.unfreeze_height=function(i){g(i).css("height","auto")};TextCritical.data_attribute_contains=function(j,l){for(var k=0;k<j.length;k++){attribute=j[k];if(attribute.name.indexOf("data-")==0){if(attribute.value.toLowerCase().indexOf(l)>=0){return true}}}return false};TextCritical.list_filter=function(i,k,j){if(typeof j=="undefined"){var j=false}g(i).change(function(){var l=g(this).val().toLowerCase();if(l){if(j){TextCritical.freeze_height(k)}g(k).find("a").each(function(m){if(g(this).text().toLowerCase().indexOf(l)>=0){g(this).parent().show()}else{if(TextCritical.data_attribute_contains(this.attributes,l)){g(this).parent().show()}else{g(this).parent().hide()}}})}else{g(k).find("li").show();if(j){TextCritical.unfreeze_height(k)}}return false}).keyup(function(){g(this).change()})};TextCritical.resolve_path=function(l,i){var j=null;var k=g.ajax({url:"/api/resolve_reference/?work="+l+"&ref="+i,async:false,success:function(m){j=m.url},type:"GET"});return j};TextCritical.facebookInit=function(){FB.init({appId:"226685657481279",xfbml:true})};TextCritical.getTextToShare=function(j,i){if(typeof j==="undefined"||j==null){var j=""}if(TextCritical.trim(j).length==0||i===true){if(window.getSelection().toString().length>0){j=window.getSelection().toString()}}j=TextCritical.trim(j);j=j.replace(/[ ]*\n[ ]*/g," ");return j};TextCritical.trimTrailingPound=function(i){if(i.slice(-1)=="#"){return i.slice(0,i.length-2)}else{return i}};TextCritical.postToFacebook=function(i,m,k,l,j){if(typeof l==="undefined"||l==null){var l=location.href}if(typeof j==="undefined"||j==null){var j=document.title}m=TextCritical.getTextToShare(m,k);FB.ui({method:"feed",link:TextCritical.trimTrailingPound(l),name:j,caption:i,description:TextCritical.shorten(m,400,true,"...")},function(n){})};TextCritical.makeTweetURL=function(j,k,i){if(typeof j==="undefined"||j==null){var j=location.href}k=TextCritical.getTextToShare(k,i);twitterLink="https://twitter.com/share";data={url:TextCritical.trimTrailingPound(j),text:TextCritical.shorten(k,140-j.length,true,"...")};return twitterLink+"?"+g.param(data)};TextCritical.postToTwitter=function(k,i,j){twitterLink=TextCritical.makeTweetURL(j,k,i);window.open(twitterLink,"_blank")};TextCritical.serialize=function(j){var k=[];for(var i in j){k.push(encodeURIComponent(i)+"="+encodeURIComponent(j[i]))}return k.join("&")};TextCritical.sendAnEmail=function(k,i,j,l){if(l===undefined||l==null){l=location.href}if(k===undefined||l==null){k=document.title}i=TextCritical.getTextToShare(i,j);data={subject:k,body:TextCritical.shorten(i,1000,true,"...")+"\n\n[Source: "+TextCritical.trimTrailingPound(l)+"]",};document.location.href="mailto:?"+TextCritical.serialize(data)};TextCritical.pollForShareButtons=function(){if(g("iframe",".sharing-buttons").length<2){setTimeout(TextCritical.pollForShareButtons,200)}else{setTimeout(function(){g(".sharing-buttons").fadeIn()},1500)}}});