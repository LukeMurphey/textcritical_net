{% extends "base_with_nav.html" %}
{% block content %}

           {% for warning in warnings %}
           <div class="alert alert-block">
		    <button type="button" class="close" data-dismiss="alert">x</button>
		    <strong>{{warning.0}}:</strong>
		    {{warning.1}}
		   </div>
           {% endfor %}
    
        <ul class="breadcrumb">
            <li><a href="{% url home %}">Home</a> <span class="divider">/</span></li>
            <li><a href="{% url works_index %}">Library</a> <span class="divider">/</span></li>
            <li class="active">{{work.title}}{% if chapter %}: {{chapter.get_division_description}}{% endif %}</li>
        </ul>
        
        <h1>{{work.title}}{% if authors|length > 0 %} <small>By {{authors|join:", "}}</small>{% endif %}</h1>
        
        {% comment %}
        ##############################
        # Button toolbar
        ##############################
        {% endcomment %} 
        
        <div class="control-group {% if verse_not_found %}error{% endif %}">
        	<div class="input-append">
        		<input class="span2" placeholder="Jump to reference..." id="chapter" value="{{chapter.get_division_description}}{% if verse_to_highlight %}:{{verse_to_highlight}}{% endif %}" type="text">
			    <button class="btn" type="button">Go!</button>
			    <button class="btn {% if not divisions or divisions|length < 2 %}disabled{% endif %}" data-toggle="button" id="show_table_of_contents">Table of Contents</button>
			    <button id="align_break" class="btn"><i class="icon-align-left"></i></button>
			</div>
        </div>
		
        {% comment %}
        ##############################
        # Table of contents
        ##############################
        {% endcomment %}
        {% load reader_extras %}
        {% if divisions and divisions|length > 1 %}
        <div class="table_of_contents ">
	        <ul class="nav nav-list">
	            {% for division_part in divisions.all %}
	               {% if chapter.parent_division.id == division_part.id %}
	            <li class="division_{{division_part.level}} active">
	                <a href="{% url read_work work.title_slug %}/{{ division_part.get_division_indicators|join:"/" }}"><i class="icon-book icon-white"></i>{{division_part|capfirst}}</a>
	            </li>
	               {% else %}
                <li class="division_{{division_part.level}}">
                    <a href="{% url read_work work.title_slug%}/{{ division_part.get_division_indicators|join:"/" }}"><i class="icon-book {% if USE_DARK_THEME|default:0 %}icon-white{% endif %}"></i>{{division_part|capfirst}}</a>
                </li>
	               {% endif %}
	            {% endfor %}
	        </ul>
        </div>
        {% endif %}
        
        {% comment %}
        ##############################
        # Chapter progress indicator
        ##############################
        {% endcomment %}
        {% if total_chapters > 1 %}
        {% load humanize %}
        {{completed_chapters|ordinal}} of {{total_chapters}} chapters ({{progress|floatformat:"0"}}%)
        <div class="reading progress progress-striped">
            <div class="bar" style="width: {{progress}}%;"></div>
        </div>
        {% endif %}
        
        {% comment %}
        #############################
        # Chapter division indicator
        ##############################
        {% endcomment %}
        
        {% if chapter.parent_division and divisions and divisions|length > 1 %}
        <h2>{{chapter.get_division_description_titles}}</h2>
        {% endif %}
        
        {% for verse in verses.all %}
        <span id="verse_{{verse.indicator}}" class="verse_container {% if verse.indicator == verse_to_highlight %}highlighted{% endif %}">
            {% if verse.indicator|length > 0 %}
            <a class="verse_link" data-verse="{{verse.indicator}}" id="verse_link_{{verse.indicator}}" href="{% url read_work work.title_slug %}/{{ chapter.get_division_indicators|join:"/" }}/{{verse.indicator}}"><span class="label {% if verse.indicator == verse_to_highlight %}label-info{% endif %} verse number">{{verse.indicator}}</span></a>
	        {% endif %}
	        {{verse.original_content|perseus_xml_to_html5:chapter.work.language|safe}}
        </span>
        {% endfor %}        
        
         
        {% comment %}
        #############################
        # Pagination
        #############################
        {% endcomment %}
        
        {% if chapters|length > 0 or previous_chapter or next_chapter %}
        <div class="pagination">
        	<ul>
        {% if previous_chapter %}
	            <li class="previous">
	            <a href="{% url read_work work.title_slug %}/{{ previous_chapter.get_division_indicators|join:"/" }}">&larr; Previous</a>
	            </li>
        {% endif %}
        {% if chapters|length > 0 %}
        {% load string_utils %}
        {% for c in chapters %}
        		{% if c == chapter %}
        		<li class="active" >
        		{% else %}
        		<li>
        		{% endif %}
        		  <a href="{% url read_work work.title_slug %}/{{ c.get_division_indicators|join:"/" }}">
        		  {% if c.title|contains:"lines" %}
        		  {{c.title}}
        		  {% else %}
        		  {{c.descriptor}}
        		  {% endif %}</a>
        		</li>
        {% endfor %}
        {% endif %}
        {% if next_chapter %}
	            <li class="next">
	            <a href="{% url read_work work.title_slug %}/{{ next_chapter.get_division_indicators|join:"/" }}">Next &rarr;</a>
	            </li>
        {% endif %}
        	</ul>
        </div>
        {% endif %}

{% endblock %}

{% block javascript %}
<script language="javascript">

require(["jquery", "store", "app"], function($) {
    loadStoreSettings();
    $('#align_break').click(toggleVerseBreak);
    $('#show_table_of_contents').click( toggleTOC );
    
    function update_chapter_reference(e) {
        if (e.keyCode == 13) {
            var ref = $(this).val();
            go_to_chapter(ref);
            return true;
        }
    }
    
    $("#chapter").keypress( update_chapter_reference );
    
    $(".verse_link").click(function() {
    	return scrollToVerse( $(this).attr("data-verse") );
    });
    
    {% if verse_to_highlight %}
    scrolltoAnchor("verse_{{verse_to_highlight}}");
    {% endif %}
});
</script>
{% endblock %}